window.CONFIG={VIRTUAL_CRT_WIDTH:800,VIRTUAL_CRT_HEIGHT:600,TEXT_COLS:80,TEXT_ROWS:24,GRAPHICS_WIDTH:640,GRAPHICS_HEIGHT:480,FONT_SIZE_PX:17,FONT_FAMILY:"monospace",SCREEN_PADDING_LEFT:8,SCREEN_PADDING_TOP:8,SCREEN_PADDING_RIGHT:8,SCREEN_PADDING_BOTTOM:8,SPRITE_SIZE:32,MAX_SPRITES:256,MAX_VECTORS:256,BRIGHTNESS_LEVELS:["#000000","#001500","#002500","#003500","#004500","#005500","#006000","#007000","#008000","#009000","#00A000","#00B000","#00C000","#00D000","#00E000","#5FFF5F"],CRT_EFFECTS:{SCANLINES_ENABLED:!0,SCANLINES_INTENSITY:.006,SCANLINES_FREQUENCY:450,BARREL_DISTORTION_ENABLED:!0,BARREL_DISTORTION_STRENGTH:-.01,NOISE_ENABLED:!0,NOISE_INTENSITY:5,NOISE_SPEED:3.5,VIGNETTE_ENABLED:!0,VIGNETTE_STRENGTH:.5,VIGNETTE_RADIUS:.85,GLARE_ENABLED:!0,GLARE_INTENSITY:.08,GLARE_SIZE:.2,GLARE_POSITION_X:.95,GLARE_POSITION_Y:.95,GLARE_FALLOFF:1.5,GLARE_BRIGHTNESS_THRESHOLD:.2,AFTERGLOW_ENABLED:!0,AFTERGLOW_PERSISTENCE:.91,BURN_IN_ENABLED:!0,BURN_IN_INTENSITY:.4,BACKGROUND_GLOW:{ENABLED:!0,COLOR:"#003300",CIRCULAR_FALLOFF_ENABLED:!0,CIRCULAR_FALLOFF_RADIUS:.7,CIRCULAR_FALLOFF_INTENSITY:1.5},FLICKER_ENABLED:!0,FLICKER_INTENSITY:.004,CHROMATIC_ABERRATION_ENABLED:!0,CHROMATIC_ABERRATION_STRENGTH:.05,SHADOW_MASK_ENABLED:!1,SHADOW_MASK_INTENSITY:.02,SHADOW_MASK_SCALE:3.5,SCREEN_JITTER_ENABLED:!0,SCREEN_JITTER_SPEED:.2,SCREEN_JITTER_AMOUNT:5e-6,HUM_BAR_ENABLED:!0,HUM_BAR_INTENSITY:.01,HUM_BAR_SPEED:.2,HUM_BAR_HEIGHT:.6,HUM_BAR_HEIGHT_VARIATION_ENABLED:!0,HUM_BAR_HEIGHT_VARIATION_AMOUNT:.5,HUM_BAR_HEIGHT_VARIATION_SPEED:4,HUM_BAR_FALLOFF_STRENGTH:1},DEBUG_VECTOR_MANAGER:!1,DEBUG_VECTOR_MANAGER_INIT:!1,DEBUG_RENDER_VECTORS:!1,DEBUG_VECTOR_PROJECTION:!1,DEBUG_MATRIX_OPERATIONS:!1,DEBUG_SPRITE_RENDER_CALL:!1,DEBUG_GRAPHICS_COMMANDS:!1,SHOW_TEST_CUBE:!1,SHOW_AXES:!1,AXES_LENGTH:50,AXES_COLOR:"#FFFFFF"},window.CRT_CONFIG=JSON.parse(JSON.stringify(window.CONFIG)),Object.assign(window.CRT_CONFIG,{VECTOR_SHOW_AXES:!1,VECTOR_AXIS_LENGTH:window.CRT_CONFIG.AXES_LENGTH||50,VECTOR_AXIS_COLOR_X:"#FF0000",VECTOR_AXIS_COLOR_Y:"#00FF00",VECTOR_AXIS_COLOR_Z:"#0000FF",VECTOR_GRID_VISIBLE:!1,VECTOR_GRID_SIZE:200,VECTOR_GRID_DIVISIONS:20,VECTOR_GRID_COLOR:"#404040",VECTOR_CAMERA_X:0,VECTOR_CAMERA_Y:0,VECTOR_CAMERA_Z:50,VECTOR_FOV:60,VECTOR_FOCAL_LENGTH:null,VECTOR_NEAR_PLANE:.1,VECTOR_FAR_PLANE:1e3,VECTOR_DEFAULT_LINE_COLOR:"#FFFFFF",VECTOR_DEFAULT_POINT_SIZE:2,TEST_CUBE_SIZE:20,TEST_CUBE_COLOR:"#00FF00",TEST_CUBE_POSITION_X:0,TEST_CUBE_POSITION_Y:0,TEST_CUBE_POSITION_Z:-30,BASE_URL:"/",SCREEN_WIDTH:window.CRT_CONFIG.VIRTUAL_CRT_WIDTH||640,SCREEN_HEIGHT:window.CRT_CONFIG.VIRTUAL_CRT_HEIGHT||480});const CFG=window.CRT_CONFIG;function updateSpriteHandlers(){if(window.spriteManager){const{handleDefineSprite:e,handleDefineVirtualSprite:t,handleUpdateSprite:n,clearAllSpriteData:o}=window.spriteManager;window.RetroGraphics.handleDefineSprite=e,window.RetroGraphics.handleUpdateSprite=n,window.RetroGraphics.handleDefineVirtualSprite=t,window.RetroGraphics.clearAllSpriteData=o}}!function(){"use strict";window.DynamicViewport={current:{actualWidth:0,actualHeight:0,canvasWidth:640,canvasHeight:480,textCols:80,textRows:24,scaleX:1,scaleY:1,offsetX:0,offsetY:0,padding:{left:0,top:0,right:0,bottom:0}},onResizeCallbacks:[],onResize:function(e){"function"==typeof e&&this.onResizeCallbacks.push(e)},calculateOptimalLayout:function(){const e=this.detectViewportSize(),t=window.CONFIG&&window.CONFIG.VIRTUAL_CRT_WIDTH?window.CONFIG.VIRTUAL_CRT_WIDTH:760,n=window.CONFIG&&window.CONFIG.VIRTUAL_CRT_HEIGHT?window.CONFIG.VIRTUAL_CRT_HEIGHT:560,o=Math.min(.05*e.width,.05*e.height),i=(e.width-2*o)/t,r=(e.height-2*o)/n,s=Math.min(i,r),a=t*s,l=n*s,c=(e.width-a)/2,d=(e.height-l)/2,u=.15*a/2,h=.15*l/2;this.current={actualWidth:e.width,actualHeight:e.height,canvasWidth:t,canvasHeight:n,textCols:window.CONFIG&&window.CONFIG.TEXT_COLS?window.CONFIG.TEXT_COLS:80,textRows:window.CONFIG&&window.CONFIG.TEXT_ROWS?window.CONFIG.TEXT_ROWS:24,scaleX:s,scaleY:s,offsetX:c,offsetY:d,scaledCanvasW:a,scaledCanvasH:l,padding:{left:u,top:h,right:u,bottom:h}};const w=t,p=n,f=this.current.textCols;let C,R,S,E;const g=window.CONFIG&&"number"==typeof window.CONFIG.SCREEN_PADDING_LEFT&&window.CONFIG.SCREEN_PADDING_LEFT>=0,m=window.CONFIG&&"number"==typeof window.CONFIG.SCREEN_PADDING_TOP&&window.CONFIG.SCREEN_PADDING_TOP>=0,T=window.CONFIG&&"number"==typeof window.CONFIG.SCREEN_PADDING_RIGHT&&window.CONFIG.SCREEN_PADDING_RIGHT>=0,v=window.CONFIG&&"number"==typeof window.CONFIG.SCREEN_PADDING_BOTTOM&&window.CONFIG.SCREEN_PADDING_BOTTOM>=0;if(g)C=window.CONFIG.SCREEN_PADDING_LEFT;else{const e=T?window.CONFIG.SCREEN_PADDING_RIGHT:.075*w;C=f>0?(w-e)/(f+1):.075*w}return R=m?window.CONFIG.SCREEN_PADDING_TOP:.075*p,S=T?window.CONFIG.SCREEN_PADDING_RIGHT:.075*w,E=v?window.CONFIG.SCREEN_PADDING_BOTTOM:.075*p,window.CONFIG&&(window.CONFIG.SCREEN_PADDING_LEFT=C,window.CONFIG.SCREEN_PADDING_TOP=R,window.CONFIG.SCREEN_PADDING_RIGHT=S,window.CONFIG.SCREEN_PADDING_BOTTOM=E),this.current},detectViewportSize:function(){const e=[{w:window.innerWidth,h:window.innerHeight,method:"innerWindow"},{w:document.documentElement.clientWidth,h:document.documentElement.clientHeight,method:"documentClient"},{w:screen.availWidth,h:screen.availHeight,method:"screenAvailable"}];let t=e[0];for(const n of e)if(n.w>200&&n.h>200&&n.w<1e4&&n.h<1e4){t=n;break}return{width:t.w,height:t.h}},basicToScreen:function(e,t){const n=this.current;return{x:n.offsetX+e/n.canvasWidth*n.scaledCanvasW,y:n.offsetY+t/n.canvasHeight*n.scaledCanvasH}},screenToBasic:function(e,t){const n=this.current;return{x:(e-n.offsetX)/n.scaledCanvasW*n.canvasWidth,y:(t-n.offsetY)/n.scaledCanvasH*n.canvasHeight}},getTextMetrics:function(){const e=this.current,t=e.scaledCanvasW-e.padding.left-e.padding.right,n=e.scaledCanvasH-e.padding.top-e.padding.bottom,o=t/e.textCols,i=n/e.textRows;return{charWidth:o,charHeight:i,fontSize:Math.max(8,Math.min(.8*i,24)),textStartX:e.offsetX+e.padding.left,textStartY:e.offsetY+e.padding.top,textAreaWidth:t,textAreaHeight:n}},recalculate:function(){this.calculateOptimalLayout();for(const e of this.onResizeCallbacks)try{e(this.current)}catch(e){console.error("[DYNAMIC-VIEWPORT] Fehler in Resize-Callback:",e)}},init:function(){this.calculateOptimalLayout(),window.addEventListener("resize",()=>{setTimeout(()=>this.recalculate(),100)}),window.addEventListener("orientationchange",()=>{setTimeout(()=>this.recalculate(),300)})}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>window.DynamicViewport.init()):window.DynamicViewport.init()}(),window.SAM={_samInstance:null,init:function(){if(void 0===window.SamJs)return!1;try{return this._samInstance=new window.SamJs({pitch:64,speed:72,mouth:128,throat:128,singmode:!1}),!0}catch(e){return!1}},Speak:function(e){if(!this._samInstance&&!this.init())throw new Error("SAM konnte nicht initialisiert werden");try{return this._samInstance.speak(e)}catch(e){throw e}}},document.addEventListener("DOMContentLoaded",function(){if(void 0===window.SamJs){const e=document.createElement("script");e.src="js/samjs.min.js",e.onload=function(){window.SAM.init()},e.onerror=function(){},document.head.appendChild(e)}else window.SAM.init()}),window.RetroGraphics=window.RetroGraphics||{},updateSpriteHandlers(),document.addEventListener("spritemanagerready",()=>{updateSpriteHandlers()});const vectorManager=window.vectorManager||{};let readBuffer,writeBuffer,postProcessingScene,orthoCamera,blitScene,blitMaterial,mainOutputCanvas;window.RetroGraphics._vectorObjects=new Map,window.RetroGraphics._spritesDirty=!1,window.RetroGraphics._graphics2DDirty=!1;const vertexShader="\n    varying vec2 vUv;\n    void main() {\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n",fragmentShader='\n    uniform float time;\n    uniform vec2 resolution;\n    uniform vec2 graphicsResolution;\n    uniform float u_paddingLeft;\n    uniform float u_paddingTop;\n    uniform float u_paddingRight;\n    uniform float u_paddingBottom;\n\n    uniform sampler2D mainTexture;          // 2D-Grafik-Canvas\n    uniform sampler2D textTextureSampler;   // Text-Canvas\n    uniform sampler2D prevFrameTexture;     // Vorheriger Frame f√ºr Afterglow\n\n    // Effekt-Uniforms\n    uniform bool scanlinesEnabled;\n    uniform float scanlineIntensity;\n    uniform float scanlineFrequency;\n\n    uniform bool barrelDistortionEnabled;\n    uniform float barrelDistortionStrength;\n    uniform float u_barrelOverscan;    \n    uniform bool noiseEnabled;\n    uniform float noiseIntensity;\n    uniform float noiseSpeed;\n    uniform float u_time;\n\n    uniform bool vignetteEnabled;\n    uniform float vignetteStrength;\n    uniform float vignetteRadius;    \n    uniform bool glareEnabled;\n    uniform float glareIntensity;\n    uniform float glareSize;\n    uniform vec2 glarePosition;\n    uniform float glareFalloff;\n    uniform float glareBrightnessThreshold;\n\n    uniform bool afterglowEnabled;\n    uniform float afterglowPersistence;\n\n    // NEU: Hintergrundleuchten\n    uniform bool backgroundGlowEnabled;\n    uniform vec3 backgroundGlowColor;\n    uniform bool circularFalloffEnabled;\n    uniform float circularFalloffRadius;    // Wie weit das Leuchten reicht\n    uniform float circularFalloffIntensity; // Wie stark der Abfall zur Kante hin ist\n\n    // NEU: Flimmer-Effekt\n    uniform bool flickerEnabled;\n    uniform float flickerIntensity;\n\n    // NEU: Chromatische Aberration\n    uniform bool chromaticAberrationEnabled;\n    uniform float chromaticAberrationStrength;\n\n    // NEU: Shadow Mask\n    uniform bool shadowMaskEnabled;\n    uniform float shadowMaskIntensity;\n    uniform float shadowMaskScale;\n\n    // NEU: Screen Jitter\n    uniform bool screenJitterEnabled;\n    uniform float screenJitterAmount;\n    uniform float screenJitterSpeed;\n\n    // Hum Bar\n    uniform bool humBarEnabled;\n    uniform float humBarIntensity;\n    uniform float humBarSpeed;\n    uniform float humBarHeight;\n    uniform bool humBarHeightVariationEnabled;\n    uniform float humBarHeightVariationAmount;\n    uniform float humBarHeightVariationSpeed;\n    uniform float humBarFalloffStrength;\n\n    varying vec2 vUv;\n\n    // Funktion f√ºr Scanlines\n    float getScanline(vec2 uv, float frequency, float intensity) {\n        return pow(sin(uv.y * frequency) * 0.5 + 0.5, intensity);\n    }    // Funktion f√ºr Rauschen/Noise\n    float random(vec2 st) {\n        return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);\n    }\n\n    float noise(vec2 uv, float time) {\n        vec2 i = floor(uv);\n        vec2 f = fract(uv);\n        \n        // Sample random values at the corners of the current cell\n        float a = random(i + vec2(0.0, 0.0) + time);\n        float b = random(i + vec2(1.0, 0.0) + time);\n        float c = random(i + vec2(0.0, 1.0) + time);\n        float d = random(i + vec2(1.0, 1.0) + time);\n        \n        // Smooth interpolation\n        vec2 u = f * f * (3.0 - 2.0 * f);\n        \n        return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;\n    }\n\n    // Funktion f√ºr Barrel Distortion (Tonnenverzeichnung)\n    vec2 barrelDistort(vec2 uv, float strength) {\n        vec2 center = vec2(0.5, 0.5);\n        vec2 texCoord = uv - center;\n\n        // This is the key: calculate the maximum distortion at the corner of the screen\n        // and pre-scale the texture coordinates to counteract it. This brings the\n        // distorted corners back into the viewport without blurring.\n        float r_corner_sq = 0.5; // (0.5*0.5 + 0.5*0.5)\n        float corner_distortion = 1.0 + strength * r_corner_sq;\n\n        // Apply the correction and the distortion\n        float r = length(texCoord);\n        float distortionFactor = 1.0 + strength * r * r;\n\n        if (distortionFactor == 0.0) { return uv; } // Avoid division by zero\n\n        vec2 distortedUv = center + (texCoord * corner_distortion) / distortionFactor;\n        return distortedUv;\n    }\n\n    void main() {\n        vec2 uv = vUv;\n\n        // Berechne die Hintergrundleuchtfarbe f√ºr den *gesamten* Bildschirm,\n        // basierend auf den unverzerrten UVs, um einen gleichm√§√üigen Effekt zu erzielen.\n        vec3 finalGlowColor = vec3(0.0);\n        if (backgroundGlowEnabled) {\n            finalGlowColor = backgroundGlowColor;\n            if (circularFalloffEnabled) {\n                // Berechne den Abstand von der Mitte des Bildschirms (unverzerrte UVs)\n                float dist = distance(uv, vec2(0.5));\n                // Gauss-Funktion f√ºr einen nat√ºrlichen, glockenf√∂rmigen Abfall von der Mitte\n                float falloff = exp(-pow(dist / circularFalloffRadius, 2.0) * circularFalloffIntensity);\n                finalGlowColor *= falloff;\n            }\n        }\n\n        // SCREEN JITTER (wird zuerst angewendet, da es die UVs f√ºr alles Folgende beeinflusst)\n        if (screenJitterEnabled) {\n            float jitterX = (random(vec2(u_time * screenJitterSpeed, 0.0)) - 0.5) * screenJitterAmount;\n            float jitterY = (random(vec2(0.0, u_time * screenJitterSpeed)) - 0.5) * screenJitterAmount;\n            uv += vec2(jitterX, jitterY);\n        }\n\n        vec2 final_uv = uv;\n\n        // Barrel Distortion anwenden, falls aktiviert\n        if (barrelDistortionEnabled) {\n            final_uv = barrelDistort(uv, barrelDistortionStrength);\n        }\n\n        // Pr√ºfen, ob die verzerrten UVs noch im g√ºltigen Bereich [0,1] sind\n        if (final_uv.x < 0.0 || final_uv.x > 1.0 || final_uv.y < 0.0 || final_uv.y > 1.0) {\n            gl_FragColor = vec4(finalGlowColor, 1.0); // Zeige das berechnete Leuchten statt einer festen Farbe\n            return;\n        }\n        \n        // Pass 1: Kombiniert Text, Grafik und wendet Effekte an\n        vec2 screen_uv_for_textures = vec2(final_uv.x, final_uv.y);\n\n        // CHROMATIC ABERRATION (wird hier angewendet, um die Textur-Samples zu verschieben)\n        vec2 offset = vec2(0.0);\n        if (chromaticAberrationEnabled) {\n            offset = (final_uv - 0.5) * chromaticAberrationStrength * 0.01;\n        }\n\n        // Text-Pixel abrufen\n        // Flip Y-Koordinate f√ºr Canvas-Texturen\n        vec4 textPixel;\n        textPixel.r = texture2D(textTextureSampler, vec2(screen_uv_for_textures.x - offset.x, 1.0 - screen_uv_for_textures.y)).r;\n        textPixel.g = texture2D(textTextureSampler, vec2(screen_uv_for_textures.x, 1.0 - screen_uv_for_textures.y)).g;\n        textPixel.b = texture2D(textTextureSampler, vec2(screen_uv_for_textures.x + offset.x, 1.0 - screen_uv_for_textures.y)).b;\n        textPixel.a = texture2D(textTextureSampler, vec2(screen_uv_for_textures.x, 1.0 - screen_uv_for_textures.y)).a;\n\n        vec2 graphics_uv = vec2(-1.0, -1.0);\n\n        // Pr√ºfe, ob der aktuelle Pixel im gerenderten Bereich liegt\n        if (screen_uv_for_textures.x * resolution.x >= u_paddingLeft && \n            screen_uv_for_textures.x * resolution.x <= resolution.x - u_paddingRight &&\n            screen_uv_for_textures.y * resolution.y >= u_paddingTop && \n            screen_uv_for_textures.y * resolution.y <= resolution.y - u_paddingBottom) {\n            \n            float relative_screen_x = screen_uv_for_textures.x * resolution.x - u_paddingLeft;\n            float relative_screen_y = screen_uv_for_textures.y * resolution.y - u_paddingTop;\n\n            float effective_gfx_width_on_screen = resolution.x - u_paddingLeft - u_paddingRight;\n            float effective_gfx_height_on_screen = resolution.y - u_paddingTop - u_paddingBottom;\n\n            if (effective_gfx_width_on_screen > 0.0 && effective_gfx_height_on_screen > 0.0) {\n                graphics_uv.x = relative_screen_x / effective_gfx_width_on_screen;\n                graphics_uv.y = relative_screen_y / effective_gfx_height_on_screen;\n            }\n        }\n        \n        vec4 graphicsPixel = vec4(0.0, 0.0, 0.0, 0.0); \n        if (graphics_uv.x >= 0.0 && graphics_uv.x <= 1.0 &&\n            graphics_uv.y >= 0.0 && graphics_uv.y <= 1.0) {\n            graphicsPixel = texture2D(mainTexture, vec2(graphics_uv.x, 1.0 - graphics_uv.y));\n        }\n\n        // Kombiniere Text und Grafik\n        vec4 combinedColor;\n        bool isTextVisible = textPixel.r > 0.01 || textPixel.g > 0.01 || textPixel.b > 0.01;\n\n        if (isTextVisible) { \n            combinedColor = textPixel;\n        } else if (graphicsPixel.a > 0.01) {\n            combinedColor = graphicsPixel;\n        } else {\n            combinedColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n\n        // Scanlines-Effekt\n        if (scanlinesEnabled) {\n            float scanlineEffect = getScanline(final_uv, scanlineFrequency, scanlineIntensity);\n            combinedColor.rgb *= scanlineEffect;\n        }\n        \n        // SHADOW MASK (simuliert die Phosphor-Punkte)\n        if (shadowMaskEnabled) {\n            float mask = 1.0 - shadowMaskIntensity;\n            float verticalMask = sin( (final_uv.y + 0.5) * resolution.y * shadowMaskScale * 0.5 );\n            float horizontalMask = sin( (final_uv.x + 0.5) * resolution.x * shadowMaskScale );\n            combinedColor.rgb *= mix(vec3(mask), vec3(1.0), (verticalMask + horizontalMask) * 0.5);\n        }\n\n        // Vignette-Effekt\n        if (vignetteEnabled) {\n            vec2 center = vec2(0.5, 0.5);\n            float dist = distance(final_uv, center);\n            float vignette = smoothstep(vignetteRadius, vignetteRadius - vignetteStrength, dist);\n            combinedColor.rgb *= vignette;\n        }\n\n        // HINTERGRUNDLEUCHTEN (Phosphor-Effekt)\n        // Das Leuchten ist eine Basisfarbe. max() stellt sicher, dass hellere Pixel nicht dunkler werden.\n        if (backgroundGlowEnabled) { // Wir verwenden die bereits berechnete finalGlowColor\n            combinedColor.rgb = max(combinedColor.rgb, finalGlowColor);\n        }\n\n        // Glare-Effekt - wird ZUERST berechnet (physikalische Reflexion des Glases)\n        vec3 glareColor = vec3(0.0);\n        float glareMask = 0.0;\n        if (glareEnabled) {\n            float glareDist = distance(final_uv, glarePosition);\n            float glare = pow(1.0 - smoothstep(0.0, glareSize, glareDist), glareFalloff) * glareIntensity;\n            \n            // Berechne die Helligkeit des urspr√ºnglichen Pixels (vor allen Effekten)\n            float brightness = dot(combinedColor.rgb, vec3(0.299, 0.587, 0.114)); // Luminanz-Gewichtung\n            \n            // Glare-Maske: St√§rker auf dunklen Bereichen, schw√§cher auf hellen (konfigurierbarer Schwellwert)\n            glareMask = (1.0 - smoothstep(0.0, glareBrightnessThreshold, brightness)) * glare;\n            \n            // Glare als separate wei√üe Reflexion\n            glareColor = vec3(glareMask);\n        }\n        \n        // CRT-Rauschen-Effekt - wird NACH Glare berechnet, aber Glare-Bereiche bleiben rauschfrei\n        if (noiseEnabled) {\n            float time = u_time * noiseSpeed * 0.1; // Skaliere die Zeit f√ºr langsamere Animation\n            float noiseValue = noise(final_uv * 200.0, time); // Hochfrequentes Rauschen\n            \n            // Berechne die Helligkeit des aktuellen Pixels\n            float brightness = dot(combinedColor.rgb, vec3(0.299, 0.587, 0.114));\n            \n            // Subtiles Rauschen, das zwischen -noiseIntensity und +noiseIntensity variiert\n            float noiseOffset = (noiseValue - 0.5) * noiseIntensity * 0.01;\n            \n            // Auf dunklen Bereichen (schwarze Pixel) verwende gr√ºnes Rauschen\n            // Auf hellen Bereichen verwende normales wei√ües Rauschen\n            vec3 darkGreen = vec3(0.0, 0.4, 0.0); // Dunkles Gr√ºn √§hnlich #00aa00\n            vec3 noiseColor = mix(darkGreen, vec3(1.0), brightness * 5.0); // Mix zwischen gr√ºn und wei√ü basierend auf Helligkeit\n            \n            // Rauschen nur dort anwenden, wo kein Glare ist (1.0 - glareMask reduziert Rauschen bei Glare)\n            float noiseReduction = 1.0 - min(glareMask, 1.0);\n            combinedColor.rgb += noiseColor * noiseOffset * noiseReduction;\n        }\n\n        // FLIMMER-EFFEKT (Helligkeitsschwankung des Phosphors)\n        if (flickerEnabled) {\n            // Erzeugt einen Wert zwischen -flickerIntensity und +flickerIntensity\n            float flicker = (random(vec2(u_time, u_time * 0.5)) * 2.0 - 1.0) * flickerIntensity;\n            combinedColor.rgb += flicker;\n        }\n\n        // HUM BAR (Netzbrummen-Streifen)\n        if (humBarEnabled) {\n            float barPosition = fract(u_time * humBarSpeed); // Position des Balkens, die √ºber die Zeit scrollt\n            float distFromBar = abs(vUv.y - barPosition); // Abstand des Pixels von der Balkenmitte\n\n            float currentBarHeight = humBarHeight;\n            if (humBarHeightVariationEnabled) {\n                // Erzeugt einen Multiplikator, der um 1.0 schwankt (z.B. 0.5 bis 1.5 bei amount=0.5)\n                float heightMultiplier = 1.0 + (random(vec2(u_time * humBarHeightVariationSpeed, 42.0)) * 2.0 - 1.0) * humBarHeightVariationAmount;\n                currentBarHeight *= heightMultiplier;\n            }\n\n            float barHeight = currentBarHeight * 0.1; // H√∂he des Balkens\n\n            // St√§rke des Effekts basierend auf der Distanz (weiche Kanten mit Gauss-Funktion f√ºr nat√ºrlicheren Abfall)\n            float humStrength = exp(-pow(distFromBar / barHeight, 2.0) * humBarFalloffStrength);\n\n            if (humStrength > 0.0) {\n                // Erzeuge ein Rauschen, das wie horizontale St√∂rlinien aussieht.\n                // Die vUv.y-Koordinate wird stark gestreckt, um Linien zu erzeugen.\n                float noise = random( vec2(vUv.x * 2.0, vUv.y * 300.0) + u_time * 20.0 );\n\n                // Die Intensit√§t des Rauschens wird durch die Position im Balken (humStrength) moduliert.\n                combinedColor.rgb += vec3(0.2, 1.0, 0.2) * noise * humStrength * humBarIntensity;\n            }\n        }\n\n        // AFTERGLOW-EFFEKT (NACHLEUCHTEN)\n        // Dieser Effekt wird als einer der letzten angewendet. Er mischt den komplett\n        // gerenderten aktuellen Frame mit dem ged√§mpften vorherigen Frame.\n        // max() stellt sicher, dass neue Inhalte immer in voller Helligkeit erscheinen,\n        // w√§hrend alte Inhalte (Nachleuchten) nur dann sichtbar sind, wenn sie heller\n        // als der aktuelle Inhalt sind.\n        if (afterglowEnabled) {\n            // WICHTIG: Der vorherige Frame (prevFrameTexture) ist bereits verzerrt.\n            // Wir m√ºssen ihn mit den *unverzerrten* UVs (vUv) abtasten, um den "Tunnel"-Effekt zu vermeiden.\n            vec4 decayedPrevFrame = texture2D(prevFrameTexture, vUv) * afterglowPersistence;\n            combinedColor = max(combinedColor, decayedPrevFrame);\n        }\n\n        // FINALE KOMPOSITION\n        // Der Glare (Reflexion auf dem Glas) wird ZULETZT hinzugef√ºgt,\n        // damit er von den anderen Effekten (Rauschen, Flimmern etc.) unber√ºhrt bleibt.\n        vec3 finalColor = max(combinedColor.rgb, glareColor);\n\n        gl_FragColor = vec4(clamp(finalColor, 0.0, 1.0), combinedColor.a);\n    }\n';let textCanvas,textTexture,textContext,glowCanvas,glowTexture,glowCtx,renderer,crtMesh,crtMaterial,crtUniforms,graphicsSpriteTexture=null,persistentGraphicsCanvas=null,persistentGraphicsContext=null,persistent2DCanvas=null,persistent2DContext=null,animationFrameId=null,animationRunning=!1;function initGraphicsPipeline(e,t){if(!document.body)return;const n=document.getElementById("terminalCanvas");if(n)mainOutputCanvas=n,mainOutputCanvas.width=CFG.VIRTUAL_CRT_WIDTH,mainOutputCanvas.height=CFG.VIRTUAL_CRT_HEIGHT;else{mainOutputCanvas=document.createElement("canvas"),mainOutputCanvas.id="terminalCanvas",mainOutputCanvas.width=CFG.VIRTUAL_CRT_WIDTH,mainOutputCanvas.height=CFG.VIRTUAL_CRT_HEIGHT;(document.querySelector(".crt-container")||document.body).appendChild(mainOutputCanvas)}try{renderer=new THREE.WebGLRenderer({canvas:mainOutputCanvas}),renderer.setSize(mainOutputCanvas.width,mainOutputCanvas.height)}catch(e){return void mainOutputCanvas.getContext("2d").fillText("WebGL Error. Cannot initialize graphics.",10,50)}const o={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,type:THREE.FloatType};if(readBuffer=new THREE.WebGLRenderTarget(mainOutputCanvas.width,mainOutputCanvas.height,o),readBuffer.texture.flipY=!1,writeBuffer=new THREE.WebGLRenderTarget(mainOutputCanvas.width,mainOutputCanvas.height,o),writeBuffer.texture.flipY=!1,e&&t?(textCanvas=e,textTexture=t):(textCanvas=document.createElement("canvas"),textCanvas.width=CFG.VIRTUAL_CRT_WIDTH,textCanvas.height=CFG.VIRTUAL_CRT_HEIGHT,textContext=textCanvas.getContext("2d"),textContext.imageSmoothingEnabled=!1,textTexture=new THREE.CanvasTexture(textCanvas),textTexture.minFilter=THREE.NearestFilter,textTexture.magFilter=THREE.NearestFilter,textTexture.flipY=!1),persistentGraphicsCanvas=document.createElement("canvas"),persistentGraphicsCanvas.width=CFG.GRAPHICS_WIDTH,persistentGraphicsCanvas.height=CFG.GRAPHICS_HEIGHT,persistentGraphicsContext=persistentGraphicsCanvas.getContext("2d"),!persistentGraphicsContext)return;if(persistentGraphicsContext.imageSmoothingEnabled=void 0!==CFG.GRAPHICS_ANTIALIASING&&CFG.GRAPHICS_ANTIALIASING,graphicsSpriteTexture=new THREE.CanvasTexture(persistentGraphicsCanvas),graphicsSpriteTexture.minFilter=THREE.NearestFilter,graphicsSpriteTexture.magFilter=THREE.NearestFilter,graphicsSpriteTexture.flipY=!1,persistent2DCanvas=document.createElement("canvas"),persistent2DCanvas.width=CFG.GRAPHICS_WIDTH,persistent2DCanvas.height=CFG.GRAPHICS_HEIGHT,persistent2DContext=persistent2DCanvas.getContext("2d"),!persistent2DContext)return;persistent2DContext.imageSmoothingEnabled=void 0!==CFG.GRAPHICS_ANTIALIASING&&CFG.GRAPHICS_ANTIALIASING,window.vectorManager&&"function"==typeof window.vectorManager.initVectorManager&&window.vectorManager.initVectorManager(persistentGraphicsCanvas,persistentGraphicsContext),postProcessingScene=new THREE.Scene,orthoCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1);const i=new THREE.PlaneGeometry(2,2);blitScene=new THREE.Scene,blitMaterial=new THREE.ShaderMaterial({uniforms:{displayTexture:{value:null}},vertexShader:vertexShader,fragmentShader:"\n            uniform sampler2D displayTexture;\n            varying vec2 vUv;\n            void main() {\n                gl_FragColor = texture2D(displayTexture, vUv);\n            }\n        ",transparent:!1,depthTest:!1,depthWrite:!1});const r=new THREE.Mesh(i,blitMaterial);blitScene.add(r),crtUniforms={textTextureSampler:{value:textTexture},mainTexture:{value:graphicsSpriteTexture},time:{value:0},resolution:{value:new THREE.Vector2(mainOutputCanvas.width,mainOutputCanvas.height)},graphicsResolution:{value:new THREE.Vector2(CFG.GRAPHICS_WIDTH||640,CFG.GRAPHICS_HEIGHT||480)},scanlinesEnabled:{value:CFG.CRT_EFFECTS.SCANLINES_ENABLED},scanlineIntensity:{value:CFG.CRT_EFFECTS.SCANLINES_INTENSITY},scanlineFrequency:{value:CFG.CRT_EFFECTS.SCANLINES_FREQUENCY},barrelDistortionEnabled:{value:CFG.CRT_EFFECTS.BARREL_DISTORTION_ENABLED},barrelDistortionStrength:{value:CFG.CRT_EFFECTS.BARREL_DISTORTION_STRENGTH},u_barrelOverscan:{value:CFG.CRT_EFFECTS.BARREL_OVERSCAN},noiseEnabled:{value:CFG.CRT_EFFECTS.NOISE_ENABLED},noiseIntensity:{value:CFG.CRT_EFFECTS.NOISE_INTENSITY},noiseSpeed:{value:CFG.CRT_EFFECTS.NOISE_SPEED},u_time:{value:0},vignetteEnabled:{value:CFG.CRT_EFFECTS.VIGNETTE_ENABLED},vignetteStrength:{value:CFG.CRT_EFFECTS.VIGNETTE_STRENGTH},vignetteRadius:{value:CFG.CRT_EFFECTS.VIGNETTE_RADIUS},glareEnabled:{value:CFG.CRT_EFFECTS.GLARE_ENABLED},glareIntensity:{value:CFG.CRT_EFFECTS.GLARE_INTENSITY},glareSize:{value:CFG.CRT_EFFECTS.GLARE_SIZE},glarePosition:{value:new THREE.Vector2(CFG.CRT_EFFECTS.GLARE_POSITION_X,CFG.CRT_EFFECTS.GLARE_POSITION_Y)},glareFalloff:{value:CFG.CRT_EFFECTS.GLARE_FALLOFF},glareBrightnessThreshold:{value:CFG.CRT_EFFECTS.GLARE_BRIGHTNESS_THRESHOLD},afterglowEnabled:{value:CFG.CRT_EFFECTS.AFTERGLOW_ENABLED},afterglowPersistence:{value:CFG.CRT_EFFECTS.AFTERGLOW_PERSISTENCE},backgroundGlowEnabled:{value:CFG.CRT_EFFECTS.BACKGROUND_GLOW.ENABLED},backgroundGlowColor:{value:new THREE.Color(CFG.CRT_EFFECTS.BACKGROUND_GLOW.COLOR)},circularFalloffEnabled:{value:CFG.CRT_EFFECTS.BACKGROUND_GLOW.CIRCULAR_FALLOFF_ENABLED},circularFalloffRadius:{value:CFG.CRT_EFFECTS.BACKGROUND_GLOW.CIRCULAR_FALLOFF_RADIUS},circularFalloffIntensity:{value:CFG.CRT_EFFECTS.BACKGROUND_GLOW.CIRCULAR_FALLOFF_INTENSITY},flickerEnabled:{value:CFG.CRT_EFFECTS.FLICKER_ENABLED},flickerIntensity:{value:CFG.CRT_EFFECTS.FLICKER_INTENSITY},chromaticAberrationEnabled:{value:CFG.CRT_EFFECTS.CHROMATIC_ABERRATION_ENABLED},chromaticAberrationStrength:{value:CFG.CRT_EFFECTS.CHROMATIC_ABERRATION_STRENGTH},shadowMaskEnabled:{value:CFG.CRT_EFFECTS.SHADOW_MASK_ENABLED},shadowMaskIntensity:{value:CFG.CRT_EFFECTS.SHADOW_MASK_INTENSITY},shadowMaskScale:{value:CFG.CRT_EFFECTS.SHADOW_MASK_SCALE},screenJitterEnabled:{value:CFG.CRT_EFFECTS.SCREEN_JITTER_ENABLED},screenJitterAmount:{value:CFG.CRT_EFFECTS.SCREEN_JITTER_AMOUNT},screenJitterSpeed:{value:CFG.CRT_EFFECTS.SCREEN_JITTER_SPEED},humBarEnabled:{value:CFG.CRT_EFFECTS.HUM_BAR_ENABLED},humBarIntensity:{value:CFG.CRT_EFFECTS.HUM_BAR_INTENSITY},humBarSpeed:{value:CFG.CRT_EFFECTS.HUM_BAR_SPEED},humBarHeight:{value:CFG.CRT_EFFECTS.HUM_BAR_HEIGHT},humBarHeightVariationEnabled:{value:CFG.CRT_EFFECTS.HUM_BAR_HEIGHT_VARIATION_ENABLED},humBarHeightVariationAmount:{value:CFG.CRT_EFFECTS.HUM_BAR_HEIGHT_VARIATION_AMOUNT},humBarHeightVariationSpeed:{value:CFG.CRT_EFFECTS.HUM_BAR_HEIGHT_VARIATION_SPEED},humBarFalloffStrength:{value:CFG.CRT_EFFECTS.HUM_BAR_FALLOFF_STRENGTH},prevFrameTexture:{value:null},u_paddingLeft:{value:CFG.SCREEN_PADDING_LEFT||0},u_paddingTop:{value:CFG.SCREEN_PADDING_TOP||0},u_paddingRight:{value:CFG.SCREEN_PADDING_RIGHT||0},u_paddingBottom:{value:CFG.SCREEN_PADDING_BOTTOM||0}},crtMaterial=new THREE.ShaderMaterial({uniforms:crtUniforms,vertexShader:vertexShader,fragmentShader:fragmentShader,transparent:!1});const s=new THREE.Mesh(i,crtMaterial);if(postProcessingScene.add(s),!(renderer&&postProcessingScene&&orthoCamera))return;if(null===animationFrameId)try{renderer.render(postProcessingScene,orthoCamera)}catch(e){}animationRunning=!0,animateCRT(),window.persistentGraphicsContext=persistentGraphicsContext,window.persistentGraphicsCanvas=persistentGraphicsCanvas,window.persistent2DContext=persistent2DContext,window.persistent2DCanvas=persistent2DCanvas,window.RetroGraphics.persistentGraphicsContext=persistentGraphicsContext,window.RetroGraphics.persistentGraphicsCanvas=persistentGraphicsCanvas,window.RetroGraphics.persistent2DContext=persistent2DContext,window.RetroGraphics.persistent2DCanvas=persistent2DCanvas;const a=new CustomEvent("retrographicsready",{detail:{success:!0}});document.dispatchEvent(a),window.retroGraphicsFullyInitialized=!0}function animateCRT(){if(animationRunning){if(animationFrameId=requestAnimationFrame(animateCRT),crtUniforms&&crtUniforms.time&&(crtUniforms.time.value=.001*performance.now(),crtUniforms.u_time.value=.001*performance.now()),textTexture&&window.RetroConsole&&window.RetroConsole.isTextCanvasDirty&&window.RetroConsole.isTextCanvasDirty()&&(textTexture.needsUpdate=!0,window.RetroConsole.markTextCanvasClean()),persistentGraphicsContext&&persistentGraphicsCanvas){const e=window.RetroGraphics&&window.RetroGraphics._spritesDirty,t=window.RetroGraphics&&window.RetroGraphics._vectorsDirty,n=window.RetroGraphics&&window.RetroGraphics._graphics2DDirty;(e||t||n)&&(persistentGraphicsContext.clearRect(0,0,persistentGraphicsCanvas.width,persistentGraphicsCanvas.height),e&&window.spriteManager&&"function"==typeof window.spriteManager.renderSprites&&window.spriteManager.renderSprites(persistentGraphicsContext),t&&window.vectorManager&&"function"==typeof window.vectorManager.renderVectors&&(window.vectorManager.renderVectors(persistentGraphicsContext,persistentGraphicsCanvas.width,persistentGraphicsCanvas.height),window.RetroGraphics._vectorsDirty=!1),persistent2DCanvas&&persistent2DContext&&(persistentGraphicsContext.drawImage(persistent2DCanvas,0,0),window.RetroGraphics._graphics2DDirty=!0),!n||persistent2DCanvas&&persistent2DContext||(window.RetroGraphics._graphics2DDirty=!1),graphicsSpriteTexture&&(graphicsSpriteTexture.needsUpdate=!0))}if(crtUniforms&&crtUniforms.u_time&&(crtUniforms.u_time.value=.001*performance.now()),renderer&&postProcessingScene&&orthoCamera)try{CFG.CRT_EFFECTS.AFTERGLOW_ENABLED&&readBuffer&&writeBuffer?(crtUniforms.prevFrameTexture.value=readBuffer.texture,renderer.setRenderTarget(writeBuffer),renderer.render(postProcessingScene,orthoCamera),blitMaterial.uniforms.displayTexture.value=writeBuffer.texture,renderer.setRenderTarget(null),renderer.render(blitScene,orthoCamera),[readBuffer,writeBuffer]=[writeBuffer,readBuffer]):(renderer.setRenderTarget(null),renderer.render(postProcessingScene,orthoCamera))}catch(e){}}}function brightnessToColor(e){if("number"!=typeof e||e<0||e>15)return"#5FFF5F";if(window.CONFIG&&window.CONFIG.BRIGHTNESS_LEVELS&&window.CONFIG.BRIGHTNESS_LEVELS[e])return window.CONFIG.BRIGHTNESS_LEVELS[e];return["#000000","#001500","#002500","#003500","#004500","#005500","#006000","#007000","#008000","#009000","#00A000","#00B000","#00C000","#00D000","#00E000","#5FFF5F"][e]||"#5FFF5F"}function getColorFromData(e){return"number"==typeof e.brightness?brightnessToColor(e.brightness):e.color&&"string"==typeof e.color?e.color:"#5FFF5F"}function updateTextTexture(e){return!!(e&&crtMaterial&&crtMaterial.uniforms&&crtMaterial.uniforms.textTextureSampler)&&(crtMaterial.uniforms.textTextureSampler.value=e,!0)}function forceTextTextureUpdate(){return!(!textTexture||!textTexture.image)&&(textTexture.needsUpdate=!0,!0)}function recreateMaterial(){return!(!crtMaterial||!crtMesh)}function handlePlot(e){if(!persistent2DCanvas||!persistent2DContext)return void console.warn("[RETROGRAPHICS] Canvas oder Context nicht verf√ºgbar f√ºr PLOT");const t=persistent2DContext;let n=getColorFromData(e);t.fillStyle=n,t.fillRect(Math.floor(e.x),Math.floor(e.y),1,1),window.RetroGraphics._graphics2DDirty=!0}function handleLine(e){if(!persistent2DCanvas||!persistent2DContext)return void console.warn("[RETROGRAPHICS] Canvas oder Context nicht verf√ºgbar f√ºr LINE");const t=persistent2DContext;let n=getColorFromData(e);t.strokeStyle=n,t.beginPath(),t.moveTo(Math.floor(e.x1),Math.floor(e.y1)),t.lineTo(Math.floor(e.x2),Math.floor(e.y2)),t.stroke(),window.RetroGraphics._graphics2DDirty=!0}function handleCircle(e){if(!persistent2DCanvas||!persistent2DContext)return void console.warn("[RETROGRAPHICS] Canvas oder Context nicht verf√ºgbar f√ºr CIRCLE");const t=persistent2DContext;let n=getColorFromData(e);t.strokeStyle=n,t.fillStyle=n,t.beginPath(),t.arc(Math.floor(e.x),Math.floor(e.y),Math.floor(e.radius),0,2*Math.PI),e.fill?t.fill():t.stroke(),window.RetroGraphics._graphics2DDirty=!0}function handleRect(e){if(!persistent2DCanvas||!persistent2DContext)return void console.error("[RECT-DEBUG] Canvas/Context nicht verf√ºgbar:",{canvas:!!persistent2DCanvas,context:!!persistent2DContext});const t=persistent2DContext;let n=getColorFromData(e);t.strokeStyle=n,t.fillStyle=n,e.fill?t.fillRect(Math.floor(e.x),Math.floor(e.y),Math.floor(e.width),Math.floor(e.height)):t.strokeRect(Math.floor(e.x),Math.floor(e.y),Math.floor(e.width),Math.floor(e.height)),window.RetroGraphics._graphics2DDirty=!0}function handleFill(e){if(!persistent2DCanvas||!persistent2DContext)return void console.warn("[RETROGRAPHICS] Canvas oder Context nicht verf√ºgbar f√ºr FILL");const t=persistent2DContext;let n=e&&e.color&&"string"==typeof e.color?e.color:"#000000";t.fillStyle=n,t.fillRect(0,0,persistent2DCanvas.width,persistent2DCanvas.height),window.RetroGraphics._graphics2DDirty=!0}function handleClearScreen(){persistent2DContext&&persistent2DCanvas&&persistent2DContext.clearRect(0,0,persistent2DCanvas.width,persistent2DCanvas.height),persistentGraphicsContext&&persistentGraphicsCanvas&&persistentGraphicsContext.clearRect(0,0,persistentGraphicsCanvas.width,persistentGraphicsCanvas.height),window.vectorManager&&"function"==typeof window.vectorManager.clearAllVectorObjects3D&&(window.vectorManager.clearAllVectorObjects3D(),"function"==typeof window.vectorManager.renderVectors&&window.vectorManager.renderVectors(persistentGraphicsContext,persistentGraphicsCanvas.width,persistentGraphicsCanvas.height)),window.spriteManager&&"function"==typeof window.spriteManager.clearActiveSpriteInstances&&window.spriteManager.clearActiveSpriteInstances(),window.RetroGraphics._graphics2DDirty=!0}function handleUpdateVector(e){if(window.CRT_CONFIG&&window.CRT_CONFIG.DEBUG_VECTOR_MANAGER,window.vectorManager&&"function"==typeof window.vectorManager.handleUpdateVector3D){const t=window.vectorManager.handleUpdateVector3D(e);return window.CRT_CONFIG&&window.CRT_CONFIG.DEBUG_VECTOR_MANAGER,t}return!1}function clearAllVectors(){window.CRT_CONFIG&&window.CRT_CONFIG.DEBUG_VECTOR_MANAGER,window.vectorManager&&"function"==typeof window.vectorManager.clearAllVectorObjects3D&&(window.vectorManager.clearAllVectorObjects3D(),window.CRT_CONFIG&&window.CRT_CONFIG.DEBUG_VECTOR_MANAGER)}function handleModeChange(e){e&&"TEXT"===e.mode||e&&e.mode}function debugGraphicsState(){}function debugCanvasLayers(){if(persistent2DCanvas){const e=persistent2DContext;e.fillStyle="#FF0000",e.fillRect(0,0,200,200)}}function debugCanvasTransfer(){persistent2DCanvas&&persistentGraphicsCanvas?(persistentGraphicsContext.clearRect(0,0,persistentGraphicsCanvas.width,persistentGraphicsCanvas.height),persistentGraphicsContext.drawImage(persistent2DCanvas,0,0),graphicsSpriteTexture&&(graphicsSpriteTexture.needsUpdate=!0),window.RetroGraphics&&window.RetroGraphics.animateCRT):console.error("- Canvas nicht verf√ºgbar:",{persistent2D:!!persistent2DCanvas,persistentGraphics:!!persistentGraphicsCanvas})}window.debugCanvasLayers=debugCanvasLayers,window.debugCanvasTransfer=debugCanvasTransfer,window.debugGraphicsState=debugGraphicsState,window.RetroGraphics.initGraphicsPipeline=initGraphicsPipeline,window.RetroGraphics.animateCRT=animateCRT,window.RetroGraphics.forceTextTextureUpdate=forceTextTextureUpdate,window.RetroGraphics.recreateMaterial=recreateMaterial,window.RetroGraphics.updateTextTexture=updateTextTexture,window.RetroGraphics.handlePlot=handlePlot,window.RetroGraphics.handleLine=handleLine,window.RetroGraphics.handleRect=handleRect,window.RetroGraphics.handleCircle=handleCircle,window.RetroGraphics.handleFill=handleFill,window.RetroGraphics.handleClearScreen=handleClearScreen,window.RetroGraphics.handleUpdateVector=handleUpdateVector,window.RetroGraphics.clearAllVectors=clearAllVectors,window.RetroGraphics.handleModeChange=handleModeChange,window.retroGraphicsFullyInitialized=!0;const retroGraphicsReadyEvent=new CustomEvent("retrographicsready",{detail:{timestamp:Date.now()}});function triggerEvilEffect(){if(!crtMaterial||!crtMaterial.uniforms||!crtMaterial.uniforms.noiseIntensity)return void console.warn("[EVIL-EFFECT] CRT material or noise intensity uniform not available");const e=window.CONFIG?window.CONFIG.CRT_EFFECTS.NOISE_INTENSITY:4;crtMaterial.uniforms.noiseIntensity.value=50,setTimeout(()=>{const t=Date.now();!function n(){const o=Date.now()-t,i=Math.min(o/5e3,1),r=1-Math.pow(1-i,3),s=50+(e-50)*r;crtMaterial.uniforms.noiseIntensity.value=s,i<1?requestAnimationFrame(n):crtMaterial.uniforms.noiseIntensity.value=e}()},1e3)}function debugDirectDraw(){const e=document.getElementById("terminalCanvas");if(e){const t=e.getContext("2d");return t.fillStyle="#00FF00",t.fillRect(10,10,100,100),!0}return console.error("- Terminal-Canvas nicht gefunden!"),!1}document.dispatchEvent(retroGraphicsReadyEvent),window.RetroGraphics.triggerEvilEffect=triggerEvilEffect,window.debugDirectDraw=debugDirectDraw;const lastRenderedSpriteInstances=new Map;window.spriteDefinitions=new Map,window.virtualSpriteCompositions=new Map,window.spriteInstances=new Map;let pendingUpdates=[];function convertPNGToQuantizedPixels(e,t){try{const n=new Image;n.onload=function(){const e=document.createElement("canvas");e.width=32,e.height=32;const o=e.getContext("2d");o.drawImage(n,0,0,32,32);const i=o.getImageData(0,0,32,32).data,r=new Uint8Array(1024);for(let e=0;e<1024;e++){const t=4*e,n=i[t],o=i[t+1],s=i[t+2];if(i[t+3]<128)r[e]=0;else{const t=(.299*n+.587*o+.114*s)/255,i=Math.round(15*t);r[e]=Math.max(1,i)}}spriteDefinitions.set(t,{pixelData:r,cachedImageData:null}),processPendingUpdates(t)},n.onerror=function(){},n.src=`data:image/png;base64,${e}`}catch(e){}}function processPendingUpdates(e){const t=[];for(let n=pendingUpdates.length-1;n>=0;n--){const o=pendingUpdates[n];o.definitionId===e&&(spriteInstances.set(o.id,{definitionId:o.definitionId,x:o.x,y:o.y,rotation:o.rotation||0,visible:!1!==o.visible}),pendingUpdates.splice(n,1),t.push(o.id))}t.length>0&&(window.RetroGraphics._spritesDirty=!0)}function createImageDataFromPixels(e,t,n){const o=document.createElement("canvas");o.width=t,o.height=n;const i=o.getContext("2d").createImageData(t,n);for(let o=0;o<t*n;++o){const t=e[o];if(0===t)i.data[4*o+3]=0;else{const e=CFG.BRIGHTNESS_LEVELS[t]||"#5FFF5F";i.data[4*o+0]=parseInt(e.substring(1,3),16),i.data[4*o+1]=parseInt(e.substring(3,5),16),i.data[4*o+2]=parseInt(e.substring(5,7),16),i.data[4*o+3]=255}}return i}window.RetroGraphics||(window.RetroGraphics={}),void 0===window.RetroGraphics._spritesDirty&&(window.RetroGraphics._spritesDirty=!1),window.handleDefineSprite=function(e){window.RetroGraphics._spritesDirty=!0;try{let t=null,n=!1;if(e&&"number"==typeof e.id&&"DEFINE_SPRITE"===e.command){if("string"==typeof e.spriteData&&e.spriteData.length>0)return void convertPNGToQuantizedPixels(e.spriteData,e.id);if(Array.isArray(e.pixelData)&&1024===e.pixelData.length)t=e.pixelData,n=!0;else if("string"==typeof e.pixelData)try{const o=e.pixelData.split(",").map(e=>parseInt(e.trim(),10));1024===o.length&&o.every(e=>!isNaN(e)&&e>=0&&e<=15)&&(t=o,n=!0)}catch(e){}if(n&&t){let n=!0,o=new Set;for(let e=0;e<t.length;e++){if("number"!=typeof t[e]||isNaN(t[e])){n=!1;break}0!==t[e]&&o.add(t[e])}if(n){const n=Uint8Array.from(t);spriteDefinitions.set(e.id,{pixelData:n,cachedImageData:null}),processPendingUpdates(e.id)}}else{let t="[SPRITE-FRONTEND-DEBUG] Ung√ºltige DEFINE_SPRITE Daten. ABGELEHNT.";e?("number"!=typeof e.id&&(t+=` Ung√ºltige/fehlende ID (erwartet number): ${JSON.stringify(e.id)}.`),"DEFINE_SPRITE"!==e.command&&(t+=` Ung√ºltiger/fehlender Command (erwartet 'DEFINE_SPRITE'): ${JSON.stringify(e.command)}.`),e.pixelData||e.spriteData?e.pixelData&&!Array.isArray(e.pixelData)&&"string"!=typeof e.pixelData?t+=` pixelData ist weder Array noch String: ${typeof e.pixelData}.`:Array.isArray(e.pixelData)&&1024!==e.pixelData.length&&(t+=` pixelData Array-L√§nge ist ${e.pixelData.length}, erwartet 1024.`):t+=" Weder pixelData noch spriteData vorhanden."):t+=" Daten-Objekt ist null oder undefined."}}}catch(e){}},window.handleDefineVirtualSprite=function(e){window.RetroGraphics._spritesDirty=!0,e&&void 0!==e.id&&e.layout&&Array.isArray(e.baseSpriteIds)&&virtualSpriteCompositions.set(e.id,{layout:e.layout,baseSpriteIds:e.baseSpriteIds})},window.handleUpdateSprite=function(e){if(spriteDefinitions.has(e.definitionId)){if(e&&"number"==typeof e.id){let t=parseFloat(e.x)||0,n=parseFloat(e.y)||0;const o={id:e.id,definitionId:e.definitionId,x:t,y:n,rotation:Number(e.rotation||0),visible:!1!==e.visible};spriteInstances.set(o.id,o),window.RetroGraphics._spritesDirty=!0}}else pendingUpdates.push({id:e.id,definitionId:e.definitionId,x:parseFloat(e.x)||0,y:parseFloat(e.y)||0,rotation:Number(e.rotation||0),visible:!1!==e.visible})},window.renderSprites=function(e,t,n){if(!window.RetroGraphics._spritesDirty)return;e.clearRect(0,0,t,n);const o=new Map;for(const[e,t]of spriteInstances){if(!t.visible)continue;let e=spriteDefinitions.get(t.definitionId);e&&e.pixelData&&0!==e.pixelData.length&&(o.has(t.definitionId)||o.set(t.definitionId,[]),o.get(t.definitionId).push(t))}for(const[t,n]of o){const o=spriteDefinitions.get(t);o.cachedImageData||(o.cachedImageData=createImageDataFromPixels(o.pixelData,CFG.SPRITE_SIZE,CFG.SPRITE_SIZE));const i=getTempCanvas(CFG.SPRITE_SIZE,CFG.SPRITE_SIZE);i.getContext("2d").putImageData(o.cachedImageData,0,0);for(const t of n){if(e.save(),window.RetroGraphics&&window.RetroGraphics.getScaledCoordinates){const n=window.RetroGraphics.getScaledCoordinates(t.x,t.y);e.translate(n.x,n.y)}else e.translate(t.x,t.y);e.rotate((t.rotation||0)*Math.PI/180),e.drawImage(i,-CFG.SPRITE_SIZE/2,-CFG.SPRITE_SIZE/2),e.restore()}releaseTempCanvas(i)}window.RetroGraphics._spritesDirty=!1};const _tempCanvasPool=[],_tempCanvasPoolUsed=new Set;function getTempCanvas(e,t){for(let n=0;n<_tempCanvasPool.length;n++){const o=_tempCanvasPool[n];if(!_tempCanvasPoolUsed.has(o)&&o.width===e&&o.height===t)return _tempCanvasPoolUsed.add(o),o}const n=document.createElement("canvas");return n.width=e,n.height=t,_tempCanvasPool.push(n),_tempCanvasPoolUsed.add(n),n}function releaseTempCanvas(e){_tempCanvasPoolUsed.delete(e)}window.clearAllSpriteData=function(){window.RetroGraphics._spritesDirty=!0,spriteDefinitions.clear(),virtualSpriteCompositions.clear(),spriteInstances.clear()},window.clearActiveSpriteInstances=function(){window.RetroGraphics._spritesDirty=!0,spriteInstances.clear()},window.spriteManager={spriteDefinitions:spriteDefinitions,virtualSpriteCompositions:virtualSpriteCompositions,spriteInstances:spriteInstances,renderSprites:renderSprites,handleDefineSprite:handleDefineSprite,handleDefineVirtualSprite:handleDefineVirtualSprite,handleUpdateSprite:handleUpdateSprite,clearAllSpriteData:clearAllSpriteData,clearActiveSpriteInstances:clearActiveSpriteInstances};const spriteManagerReadyEvent=new CustomEvent("spritemanagerready",{detail:{timestamp:Date.now()}});document.dispatchEvent(spriteManagerReadyEvent),window.RetroGraphics||(window.RetroGraphics={}),void 0===window.RetroGraphics._vectorsDirty&&(window.RetroGraphics._vectorsDirty=!1);let graphicsCanvas=null,camera=null,vectorObjects=[],objectIdCounter=0,testCube=null,axes=null;function toRadians(e){return e*(Math.PI/180)}function createTestCube(e=10,t={x:0,y:0,z:0},n="#00FF00"){const o=e/2,i={id:"test_cube_"+objectIdCounter++,vertices:[{x:-o,y:-o,z:-o},{x:o,y:-o,z:-o},{x:o,y:o,z:-o},{x:-o,y:o,z:-o},{x:-o,y:-o,z:o},{x:o,y:-o,z:o},{x:o,y:o,z:o},{x:-o,y:o,z:o}],edges:[[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]],color:n,worldMatrix:createIdentityMatrix(),transform:{translation:{x:t.x,y:t.y,z:t.z},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},visible:!0};return updateWorldMatrix(i),i}function createSphere(e=5,t={x:0,y:0,z:0},n="#00FF00",o=8){const i=[],r=[];i.push({x:0,y:e,z:0}),i.push({x:0,y:-e,z:0});const s=o,a=o;for(let t=1;t<s;t++){const n=Math.PI*t/s,o=e*Math.cos(n),r=e*Math.sin(n);for(let e=0;e<a;e++){const t=2*Math.PI*e/a,n=r*Math.cos(t),s=r*Math.sin(t);i.push({x:n,y:o,z:s})}}const l=i.length;for(let e=0;e<a;e++)r.push([0,2+e]),r.push([1,l-a+e]);for(let e=0;e<s-2;e++){const t=2+e*a,n=2+(e+1)*a;for(let e=0;e<a;e++){const o=t+e,i=n+e;r.push([o,i])}}for(let e=0;e<s-1;e++){const t=2+e*a;for(let e=0;e<a;e++){const n=t+e,o=t+(e+1)%a;r.push([n,o])}}const c={id:"sphere_"+objectIdCounter++,vertices:i,edges:r,color:n,worldMatrix:createIdentityMatrix(),transform:{translation:{x:t.x,y:t.y,z:t.z},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},visible:!0,shape:"sphere"};return updateWorldMatrix(c),c}function createAxes(e=50){const t={id:"axes_"+objectIdCounter++,vertices:[{x:0,y:0,z:0},{x:e,y:0,z:0},{x:0,y:e,z:0},{x:0,y:0,z:e}],edges:[[0,1],[0,2],[0,3]],color:CFG.AXES_COLOR||"#FFFFFF",worldMatrix:createIdentityMatrix(),transform:{translation:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},visible:!0,edgeColors:["#FF0000","#00FF00","#0000FF"]};return updateWorldMatrix(t),t}function initVectorManager(e,t){if(!e)return void console.error("[VECTOR-MANAGER-INIT] Canvas instance is required!");graphicsCanvas=e,vectorObjects=[],objectIdCounter=0;const n={x:void 0!==CFG.VECTOR_CAMERA_X?CFG.VECTOR_CAMERA_X:0,y:void 0!==CFG.VECTOR_CAMERA_Y?CFG.VECTOR_CAMERA_Y:0,z:void 0!==CFG.VECTOR_CAMERA_Z?CFG.VECTOR_CAMERA_Z:50,fov:CFG.VECTOR_FOV||60,near:CFG.VECTOR_NEAR_PLANE||.1,far:CFG.VECTOR_FAR_PLANE||1e3,focalLength:CFG.VECTOR_FOCAL_LENGTH};if(!graphicsCanvas)return void console.error("[VECTOR-MANAGER-INIT] graphicsCanvas is not set, cannot calculate focal length.");let o;if(null==n.focalLength){const e=toRadians(n.fov);o=graphicsCanvas.width/2/Math.tan(e/2)}else o=n.focalLength;camera={x:n.x,y:n.y,z:n.z,focalLength:o,fov:n.fov,near:n.near,far:n.far},!1!==CFG.SHOW_TEST_CUBE&&(testCube=createTestCube({x:CFG.TEST_CUBE_POSITION_X,y:CFG.TEST_CUBE_POSITION_Y,z:CFG.TEST_CUBE_POSITION_Z},CFG.TEST_CUBE_COLOR),addVectorObject(testCube)),!1!==CFG.SHOW_AXES&&(axes=createAxes(CFG.AXES_LENGTH),addVectorObject(axes))}function createIdentityMatrix(){return{m:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}}function createTranslationMatrix(e,t,n){return{m:[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1]}}function createScaleMatrix(e,t,n){return{m:[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1]}}function createRotationMatrixX(e){const t=Math.cos(e),n=Math.sin(e);return{m:[1,0,0,0,0,t,n,0,0,-n,t,0,0,0,0,1]}}function createRotationMatrixY(e){const t=Math.cos(e),n=Math.sin(e);return{m:[t,0,-n,0,0,1,0,0,n,0,t,0,0,0,0,1]}}function createRotationMatrixZ(e){const t=Math.cos(e),n=Math.sin(e);return{m:[t,n,0,0,-n,t,0,0,0,0,1,0,0,0,0,1]}}function multiplyMatrices(e,t){const n={m:[]},o=e.m,i=t.m;if(!o||!i)return console.error("[MATRIX] Error: Invalid matrices provided for multiplication.",e,t),createIdentityMatrix();for(let e=0;e<4;e++)for(let t=0;t<4;t++){let r=0;for(let n=0;n<4;n++)r+=o[t+4*n]*i[n+4*e];n.m[t+4*e]=r}return n}function addVectorObject(e){return e&&void 0!==e.id?vectorObjects.some(t=>t.id===e.id)?(console.warn(`[VECTOR-MANAGER] Objekt mit ID ${e.id} existiert bereits. √úberspringe Hinzuf√ºgen.`),vectorObjects.find(t=>t.id===e.id)):(vectorObjects.push(e),e):(console.error("[VECTOR-MANAGER] Versuch, ein ung√ºltiges oder ID-loses Objekt hinzuzuf√ºgen:",e),null)}function removeVectorObject(e){const t=vectorObjects.length;return vectorObjects=vectorObjects.filter(t=>t.id!==e),vectorObjects.length<t||(CFG.DEBUG_VECTOR_MANAGER&&console.warn(`[VECTOR-MANAGER] Objekt zum Entfernen nicht gefunden (ID: ${e}).`),!1)}function getObjectById(e){return vectorObjects.find(t=>t.id===e)||null}function getAllObjectIds(){return vectorObjects.map(e=>e.id)}function setObjectVisibility(e,t){const n=getObjectById(e);return n?(n.visible=!!t,!0):(CFG.DEBUG_VECTOR_MANAGER&&console.warn(`[VECTOR-MANAGER] Objekt ${e} f√ºr Sichtbarkeits√§nderung nicht gefunden.`),!1)}function updateWorldMatrix(e){if(!e||!e.transform)return void console.error("[MATRIX] updateWorldMatrix: Ung√ºltiges Objekt oder fehlende Transformation.",e);let t=createIdentityMatrix();t=multiplyMatrices(t,createScaleMatrix(e.transform.scale.x,e.transform.scale.y,e.transform.scale.z)),t=multiplyMatrices(t,createRotationMatrixX(e.transform.rotation.x)),t=multiplyMatrices(t,createRotationMatrixY(e.transform.rotation.y)),t=multiplyMatrices(t,createRotationMatrixZ(e.transform.rotation.z)),t=multiplyMatrices(t,createTranslationMatrix(e.transform.translation.x,e.transform.translation.y,e.transform.translation.z)),e.worldMatrix=t}function updateObjectTransform(e,t){const n=getObjectById(e);return n&&n.transform&&t?(t.translation&&(n.transform.translation={...n.transform.translation,...t.translation}),t.rotation&&(n.transform.rotation={...n.transform.rotation,...t.rotation}),t.scale&&(n.transform.scale={...n.transform.scale,...t.scale}),updateWorldMatrix(n),!0):(console.warn(`[VECTOR-MANAGER] updateObjectTransform: Objekt ${e} nicht gefunden, hat keine Transformationseigenschaft oder keine neue Transformation bereitgestellt.`),!1)}function rotateObject(e,t,n){const o=getObjectById(e);if(o){if("x"===t)o.transform.rotation.x+=n;else if("y"===t)o.transform.rotation.y+=n;else{if("z"!==t)return void console.error("[VECTOR-MANAGER] rotateObject: Ung√ºltige Achse:",t);o.transform.rotation.z+=n}updateWorldMatrix(o)}else console.warn(`[VECTOR-MANAGER] rotateObject: Objekt ${e} nicht gefunden.`)}function translateObject(e,t,n,o){const i=getObjectById(e);i?(i.transform.translation.x+=t,i.transform.translation.y+=n,i.transform.translation.z+=o,updateWorldMatrix(i)):console.warn(`[VECTOR-MANAGER] translateObject: Objekt ${e} nicht gefunden.`)}function scaleObject(e,t,n,o){const i=getObjectById(e);i?(i.transform.scale.x*=t,i.transform.scale.y*=n,i.transform.scale.z*=o,updateWorldMatrix(i)):console.warn(`[VECTOR-MANAGER] scaleObject: Objekt ${e} nicht gefunden.`)}function projectVertex(e,t,n,o){const i=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8]+t.m[12],r=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9]+t.m[13],s=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10]+t.m[14],a=i-n.x,l=r-n.y,c=n.z-s;if(c<=n.near||c>=n.far)return{x:0,y:0,projectedX:0,projectedY:0,scale:0,visible:!1,reason:c<=n.near?"near_clip":"far_clip"};const d=n.focalLength/c,u=a*d,h=l*d;return{x:i,y:r,z:s,projectedX:u,projectedY:h,screenX:o.width/2+u,screenY:o.height/2-h,scale:d,visible:!0}}function renderVectors(e,t,n){graphicsCanvas&&camera&&e?vectorObjects.forEach((t,n)=>{if(!t||!t.visible)return;if(!t.vertices||!t.edges)return void console.warn("[VECTOR-MANAGER-RENDER] Skipping invalid object (missing vertices, or edges):",t.id,t);if(void 0===t.worldMatrix||null===t.worldMatrix||void 0===t.worldMatrix.m)return void console.error(`[VECTOR-MANAGER-RENDER] CRITICAL: worldMatrix is invalid for object ID ${t.id}. Skipping rendering this object.`,t.worldMatrix);const o=t.color||"#FFFFFF";e.strokeStyle=o,e.lineWidth=t.lineWidth||1,e.beginPath(),t.edges.forEach((n,i)=>{if(!Array.isArray(n)||n.length<2)return void console.warn("[VECTOR-MANAGER-RENDER] Skipping invalid edge (not an array or less than 2 vertices):",n,"for object:",t.id);const r=n.map(e=>{if("number"!=typeof e||e<0||e>=t.vertices.length)return console.error(`[VECTOR-MANAGER-RENDER] Invalid vertexIndex ${e} for object ${t.id} with ${t.vertices.length} vertices.`),{visible:!1,reason:"invalid_vertex_index"};const n=t.vertices[e];return n&&void 0!==n.x&&void 0!==n.y&&void 0!==n.z?projectVertex(n,t.worldMatrix,camera,graphicsCanvas):(console.error(`[VECTOR-MANAGER-RENDER] Vertex at index ${e} for object ${t.id} is undefined or malformed.`,n),{visible:!1,reason:"undefined_or_malformed_vertex"})}).filter(e=>e&&e.visible);2===r.length&&(t.id&&t.id.startsWith("axes_")&&t.edgeColors&&t.edgeColors[i]?(e.stroke(),e.strokeStyle=t.edgeColors[i],e.beginPath(),e.moveTo(r[0].screenX,r[0].screenY),e.lineTo(r[1].screenX,r[1].screenY),e.stroke(),e.strokeStyle=o,e.beginPath()):(e.moveTo(r[0].screenX,r[0].screenY),e.lineTo(r[1].screenX,r[1].screenY)))}),e.stroke()}):console.warn("[VECTOR-MANAGER-RENDER] Graphics components not initialized. Skipping render.",{hasCanvas:!!graphicsCanvas,hasCamera:!!camera,hasContext:!!e})}function handleUpdateVector3D(e){if(void 0!==e.id){const t=e.id;let n=vectorObjects.find(e=>e.id===`vector_${t}`);if(e.shape&&e.position&&e.vecRotation&&void 0!==e.scale){const o=e.shape,i=e.position,r=e.vecRotation,s=e.scale,a=e.brightness||15;n||("cube"===o?(n=createTestCube(s,i,getBrightnessColor(a)),n.id=`vector_${t}`,n.originalId=t,n.shape=o):"sphere"===o?(n=createSphere(s/2,i,getBrightnessColor(a)),n.id=`vector_${t}`,n.originalId=t,n.shape=o):(n=createTestCube(s,i,getBrightnessColor(a)),n.id=`vector_${t}`,n.originalId=t,n.shape=o),vectorObjects.push(n)),n.transform.translation.x=i.x,n.transform.translation.y=i.y,n.transform.translation.z=i.z,n.transform.rotation.x=r.x,n.transform.rotation.y=r.y,n.transform.rotation.z=r.z,"number"==typeof s?(n.transform.scale.x=s,n.transform.scale.y=s,n.transform.scale.z=s):s&&"object"==typeof s&&(n.transform.scale.x=s.x||n.transform.scale.x,n.transform.scale.y=s.y||n.transform.scale.y,n.transform.scale.z=s.z||n.transform.scale.z),n.color=getBrightnessColor(a)}n&&(void 0!==e.visible&&(n.visible=!!e.visible),void 0===e.scale||e.shape||("number"==typeof e.scale?(n.transform.scale.x=e.scale,n.transform.scale.y=e.scale,n.transform.scale.z=e.scale):e.scale&&"object"==typeof e.scale&&(n.transform.scale.x=e.scale.x||n.transform.scale.x,n.transform.scale.y=e.scale.y||n.transform.scale.y,n.transform.scale.z=e.scale.z||n.transform.scale.z)),void 0!==e.brightness&&(n.color=getBrightnessColor(e.brightness)),updateWorldMatrix(n),window.RetroGraphics._vectorsDirty=!0)}else testCube&&(testCube.transform.rotation.y+=toRadians(1),updateWorldMatrix(testCube),window.RetroGraphics._vectorsDirty=!0)}function getBrightnessColor(e){e=Math.max(0,Math.min(15,e||15));return(CFG.BRIGHTNESS_LEVELS||["#000000","#001500","#002500","#003500","#004500","#005500","#006000","#007000","#008000","#009000","#00A000","#00B000","#00C000","#00D000","#00E000","#5FFF5F"])[e]}function clearAllVectorObjects3D(){if(vectorObjects=[],testCube=null,axes=null,objectIdCounter=0,graphicsCanvas&&graphicsCanvas.getContext){const e=graphicsCanvas.getContext("2d");e&&e.clearRect(0,0,graphicsCanvas.width,graphicsCanvas.height)}}function playSound(e,t){try{window.RetroSound.audioContext||(window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext));const n=window.RetroSound.audioContext;"suspended"===n.state&&n.resume();const o=n.createOscillator(),i=n.createGain();o.type="sine",o.frequency.setValueAtTime(e||440,n.currentTime),i.gain.setValueAtTime(.2,n.currentTime),o.connect(i),i.connect(n.destination),o.start(),o.stop(n.currentTime+(t?t/1e3:.2))}catch(e){}}function playNoise(e,t){try{window.RetroSound.audioContext||(window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext));const n=window.RetroSound.audioContext;"suspended"===n.state&&n.resume();const o=n.sampleRate*(t/1e3||.5),i=n.createBuffer(1,o,n.sampleRate),r=i.getChannelData(0);switch(e){case"white":default:for(let e=0;e<o;e++)r[e]=2*Math.random()-1;break;case"pink":let e=0,t=0,n=0,i=0,s=0,a=0,l=0;for(let c=0;c<o;c++){const o=2*Math.random()-1;e=.99886*e+.0555179*o,t=.99332*t+.0750759*o,n=.969*n+.153852*o,i=.8665*i+.3104856*o,s=.55*s+.5329522*o,a=-.7616*a-.016898*o,r[c]=e+t+n+i+s+a+l+.5362*o,r[c]*=.11,l=.115926*o}break;case"brown":let c=0;for(let e=0;e<o;e++){const t=2*Math.random()-1;r[e]=(c+.02*t)/1.02,c=r[e],r[e]*=3.5}}const s=n.createBufferSource(),a=n.createGain();s.buffer=i,a.gain.setValueAtTime(.1,n.currentTime),s.connect(a),a.connect(n.destination),s.start()}catch(e){}}function initSpeech(){RetroSound.useBrowserSpeech=!1;try{if(void 0===window.SamJs){const e=document.createElement("script");return e.src="js/samjs.min.js",document.head.appendChild(e),window.RetroConsole&&window.RetroConsole.appendLine("SAM.js wird nachgeladen..."),!1}return null!==window.RetroSound.samSpeech||(window.RetroSound.samSpeech=new window.SamJs({pitch:64,speed:72,mouth:128,throat:128,singmode:!1})),!0}catch(e){return window.RetroConsole&&window.RetroConsole.appendLine("Fehler bei SAM-Initialisierung. Sprachausgabe eventuell nicht verf√ºgbar."),!1}}function initSamAudioDetection(){try{return RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext),!0}catch(e){return!1}}function speakText(e){if(e&&""!==e.trim()&&!(e===RetroSound.lastSpeechText&&Date.now()-RetroSound._lastSpeechTime<1e3||(RetroSound.lastSpeechText=e,RetroSound._lastSpeechTime=Date.now(),RetroSound.processingQueue))){if(RetroSound.processingQueue=!0,RetroSound.isSpeaking)return window.speechSynthesis&&window.speechSynthesis.cancel(),RetroSound.isSpeaking=!1,void setTimeout(()=>{RetroSound.processingQueue=!1,t()},100);t()}function t(){if(RetroSound.isSpeaking=!0,RetroSound.processingQueue=!1,!RetroSound.samSpeech){if(!initSpeech())return window.RetroConsole&&window.RetroConsole.appendLine("ERROR: SAM Sprachausgabe konnte nicht initialisiert werden."),RetroSound.isSpeaking=!1,void n()}if(RetroSound.samSpeech)try{let t=e.replace(/[^a-zA-Z0-9\s.,!?-]/g,"").replace(/\s+/g," ").trim();if(!t)return RetroSound.isSpeaking=!1,void n();if(/^\d+$/.test(t)){const e={0:"zero",1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",8:"eight",9:"nine"};let n="";for(let o=0;o<t.length;o++)n+=e[t[o]]+" ";t=n.trim()}return void RetroSound.samSpeech.speak(t).then(()=>{RetroSound.isSpeaking=!1,n()}).catch(e=>{RetroSound.isSpeaking=!1,n(),window.RetroConsole&&window.RetroConsole.appendLine("ERROR: SAM Sprachausgabe fehlgeschlagen.")})}catch(e){return RetroSound.isSpeaking=!1,n(),void(window.RetroConsole&&window.RetroConsole.appendLine("ERROR: SAM Sprachausgabe fehlgeschlagen."))}window.RetroConsole&&window.RetroConsole.appendLine("ERROR: SAM Sprachausgabe nicht verf√ºgbar."),RetroSound.isSpeaking=!1,n()}function n(){if(!RetroSound.isSpeaking&&0===RetroSound.speechEndCallbacks.length)return void(RetroSound.processingQueue&&(RetroSound.processingQueue=!1));RetroSound.isSpeaking=!1,RetroSound.processingQueue=!1;const e=[...RetroSound.speechEndCallbacks];RetroSound.speechEndCallbacks=[],setTimeout(()=>{e.forEach((e,t)=>{try{e()}catch(e){}})},10)}}function isSpeechActive(){return RetroSound.isSpeaking}function onSpeechEnd(e){"function"==typeof e&&(RetroSound.speechEndCallbacks.push(e),RetroSound.isSpeaking||setTimeout(()=>{RetroSound.speechEndCallbacks.includes(e)&&RetroSound.handleSpeechEnd()},10))}function clearSpeechEndCallbacks(){RetroSound.speechEndCallbacks=[]}function forceBrowserSpeech(e){return RetroSound.useBrowserSpeech=!1,!1}function playBeep(){try{window.RetroSound.audioContext||(window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext));const e=window.RetroSound.audioContext;"suspended"===e.state&&e.resume();const t=e.createOscillator(),n=e.createGain();t.type="square",t.frequency.setValueAtTime(800,e.currentTime),n.gain.setValueAtTime(.5,e.currentTime),t.connect(n),n.connect(e.destination),t.start(),t.stop(e.currentTime+.2)}catch(e){}}function playFloppySound(){if(window.RetroSound.floppyAudio&&window.RetroSound.floppyUnlocked)try{window.RetroSound.floppyAudio.currentTime=0,window.RetroSound.floppyAudio.play().then(()=>{}).catch(e=>{})}catch(e){}else window.RetroSound.floppyAudio&&!window.RetroSound.floppyUnlocked&&(window.RetroSound.floppyUnlocked=!0,playFloppySound())}window.vectorManager={initVectorManager:initVectorManager,addVectorObject:addVectorObject,removeVectorObject:removeVectorObject,updateObjectTransform:updateObjectTransform,getObjectById:getObjectById,getAllObjectIds:getAllObjectIds,setObjectVisibility:setObjectVisibility,rotateObject:rotateObject,translateObject:translateObject,scaleObject:scaleObject,renderVectors:renderVectors,getTestCube:()=>testCube,getAxes:()=>axes,getCamera:()=>camera,getGraphicsCanvas:()=>graphicsCanvas,toRadians:toRadians,createIdentityMatrix:createIdentityMatrix,createTranslationMatrix:createTranslationMatrix,createScaleMatrix:createScaleMatrix,createRotationMatrixX:createRotationMatrixX,createRotationMatrixY:createRotationMatrixY,createRotationMatrixZ:createRotationMatrixZ,multiplyMatrices:multiplyMatrices,updateWorldMatrix:updateWorldMatrix,handleUpdateVector3D:handleUpdateVector3D,clearAllVectorObjects3D:clearAllVectorObjects3D},window.vectorManager={initVectorManager:initVectorManager,renderVectors:renderVectors,createTestCube:createTestCube,createSphere:createSphere,createAxes:createAxes,addVectorObject:addVectorObject,removeVectorObject:removeVectorObject,getVectorObjects:()=>vectorObjects,getCamera:()=>camera,getGraphicsCanvas:()=>graphicsCanvas,toRadians:toRadians,createIdentityMatrix:createIdentityMatrix,createTranslationMatrix:createTranslationMatrix,createScaleMatrix:createScaleMatrix,createRotationMatrixX:createRotationMatrixX,createRotationMatrixY:createRotationMatrixY,createRotationMatrixZ:createRotationMatrixZ,multiplyMatrices:multiplyMatrices,updateWorldMatrix:updateWorldMatrix,handleUpdateVector3D:handleUpdateVector3D,clearAllVectorObjects3D:clearAllVectorObjects3D},window.RetroSound={floppyAudio:null,floppyUnlocked:!1,samSpeech:null,audioContext:null,isSpeaking:!1,lastSpeechText:"",processingQueue:!1,_lastSpeechTime:0,speechEndCallbacks:[],useBrowserSpeech:!1,lastSpeechID:0,pendingSpeechRequests:{},initSpeech:null,speakText:null,playBeep:null,playFloppySound:null,unlockAudio:null,initAudio:null,isSpeechActive:null,onSpeechEnd:null,clearSpeechEndCallbacks:null,forceBrowserSpeech:null,speakTextWithID:null,sendSpeechDone:null,getWebSocket:null,playSound:playSound,playNoise:playNoise},RetroSound.handleSpeechEnd=function(){if(!RetroSound.isSpeaking&&0===RetroSound.speechEndCallbacks.length)return void(RetroSound.processingQueue&&(RetroSound.processingQueue=!1));RetroSound.isSpeaking=!1,RetroSound.processingQueue=!1;const e=[...RetroSound.speechEndCallbacks];RetroSound.speechEndCallbacks=[],setTimeout(()=>{e.forEach((e,t)=>{})},10)};let audioContextInitialized=!1,audioContextInitLogged=!1;function unlockAudio(){if(window.RetroSound.audioContext)audioContextInitLogged||(audioContextInitLogged=!0);else try{window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){}}function getWebSocketInstance(){return window.backendSocket&&window.backendSocket.readyState===WebSocket.OPEN?window.backendSocket:window.ws&&window.ws.readyState===WebSocket.OPEN?window.ws:null}function speakTextWithID(e,t){if(e&&""!==e.trim())if(window.RetroSound.lastSpeechID=t,window.RetroSound.pendingSpeechRequests[t]=!0,window.RetroSound.samSpeech||initSpeech(),window.RetroSound.samSpeech&&void 0!==window.SamJs)try{let n=e.replace(/[^a-zA-Z0-9\s.,!?-]/g,"").replace(/\s+/g," ").trim();if(!n)return void window.RetroSound.sendSpeechDone(t);if(/^\d+$/.test(n)){const e={0:"zero",1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",8:"eight",9:"nine"};let t="";for(let o=0;o<n.length;o++)t+=e[n[o]]+" ";n=t.trim()}const o=window.RetroSound.samSpeech.speak(n);if(o&&"function"==typeof o.then)o.then(()=>{window.RetroSound.pendingSpeechRequests[t]&&(window.RetroSound.sendSpeechDone(t),delete window.RetroSound.pendingSpeechRequests[t])}).catch(e=>{window.RetroSound.pendingSpeechRequests[t]&&(window.RetroSound.sendSpeechDone(t),delete window.RetroSound.pendingSpeechRequests[t])});else{const e=100*n.length;setTimeout(()=>{window.RetroSound.pendingSpeechRequests[t]&&(window.RetroSound.sendSpeechDone(t),delete window.RetroSound.pendingSpeechRequests[t])},e)}}catch(e){window.RetroConsole&&window.RetroConsole.appendLine("ERROR: SAM Sprachausgabe fehlgeschlagen."),window.RetroSound.sendSpeechDone(t),delete window.RetroSound.pendingSpeechRequests[t]}else{window.RetroConsole&&window.RetroConsole.appendLine("ERROR: SAM Sprachausgabe nicht verf√ºgbar.");const e=document.createElement("script");e.src="js/samjs.min.js",e.onload=function(){window.RetroConsole&&window.RetroConsole.appendLine("SAM.js nachgeladen. Versuchen Sie erneut zu sprechen."),window.RetroSound.sendSpeechDone(t),delete window.RetroSound.pendingSpeechRequests[t]},e.onerror=function(){window.RetroConsole&&window.RetroConsole.appendLine("FEHLER: SAM.js konnte nicht geladen werden!"),window.RetroSound.sendSpeechDone(t),delete window.RetroSound.pendingSpeechRequests[t]},document.head.appendChild(e)}else window.RetroSound.sendSpeechDone(t)}function sendSpeechDone(e){const t=getWebSocketInstance();if(t&&t.readyState===WebSocket.OPEN){const n={type:6,speechId:e};t.send(JSON.stringify(n))}else{t&&t.readyState}}function playNoise(e,t,n){if(!window.AudioContext&&!window.webkitAudioContext)return;window.RetroSound.audioContext||(window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext));const o=window.RetroSound.audioContext;"suspended"===o.state&&o.resume();const i=2*o.sampleRate,r=o.createBuffer(1,i,o.sampleRate),s=r.getChannelData(0);for(let e=0;e<i;e++)s[e]=2*Math.random()-1;const a=o.createBufferSource();a.buffer=r;const l=o.createBiquadFilter();l.type="bandpass";const c=50*Math.pow(100,e/255);l.frequency.value=c,l.Q.value=1;const d=o.createGain();d.gain.value=0;const u=6*t,h=6*n,w=o.currentTime;d.gain.setValueAtTime(0,w),d.gain.linearRampToValueAtTime(.7,w+u/1e3),d.gain.linearRampToValueAtTime(0,w+u/1e3+h/1e3),a.connect(l),l.connect(d),d.connect(o.destination);try{a.start(),a.stop(w+u/1e3+h/1e3+.1)}catch(e){}}function playNoiseSimple(e,t){const n=Math.min(255,t/10);try{playNoise(128,10,n)}catch(e){}}function playNoiseComplex(e,t,n){try{window.RetroSound.audioContext||(window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext));const o=window.RetroSound.audioContext;"suspended"===o.state?o.resume().then(()=>{playNoiseComplexInternal(o,e,t,n)}).catch(e=>{}):playNoiseComplexInternal(o,e,t,n)}catch(e){}}function playNoiseComplexInternal(e,t,n,o){try{const i=Math.max(1,Math.min(255,t||128)),r=Math.max(1,Math.min(255,n||10)),s=Math.max(1,Math.min(255,o||50)),a=10*(r+s),l=e.sampleRate*(a/1e3),c=e.createBuffer(1,l,e.sampleRate),d=c.getChannelData(0),u=55+i/255*1e3;for(let t=0;t<l;t++){const n=2*Math.random()-1,o=t/e.sampleRate;let i=1;const l=r/255*(a/2e3);if(o<l)i=o/l;else{const e=(o-l)/(s/255*(a/1e3));i=Math.exp(3*-e)}const c=.3*Math.sin(o*u*2*Math.PI);d[t]=(n+c)*i*.3}const h=e.createBufferSource(),w=e.createGain();h.buffer=c,w.gain.setValueAtTime(.2,e.currentTime),h.connect(w),w.connect(e.destination),h.start()}catch(e){}}function openSidMusic(e){try{if(window.sidPlayer&&"function"==typeof window.sidPlayer.loadSID){const t=`/api/file?path=${encodeURIComponent(e)}`;window.sidPlayer.loadSID(t,e)}else openSidMusicLegacy(e)}catch(t){openSidMusicLegacy(e)}}function openSidMusicLegacy(e){try{window.RetroSound.audioContext||(window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext));const t=window.RetroSound.audioContext;"suspended"===t.state&&t.resume(),stopSidMusic();const n=`/api/file?path=${encodeURIComponent(e)}`;fetch(n).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.arrayBuffer()}).then(e=>processSidFile(e)).then(e=>{window.RetroSound.sidPlayer.currentSid=e}).catch(t=>{generateFallbackSidAudio(e)})}catch(t){generateFallbackSidAudio(e)}}function processSidFile(e){return new Promise((t,n)=>{try{const n=window.RetroSound.audioContext,o=new Uint8Array(e),i=String.fromCharCode(...o.slice(0,4));if("PSID"===i||"RSID"===i){t(generateSidAudio(o,n))}else{t(generateFallbackAudio(n))}}catch(e){n(e)}})}function generateSidAudio(e,t){const n=t.sampleRate,o=30*n,i=t.createBuffer(1,o,n),r=i.getChannelData(0);let s=440,a=0;for(let t=0;t<o;t++){const i=Math.floor(t/o*(e.length-124))+124;if(i<e.length){s=220+2*e[i]}const l=Math.sin(a)>0?.3:-.3,c=.1*Math.sin(2*a),d=.05*Math.sin(3*a);r[t]=l+c+d,a+=2*Math.PI*s/n,a>=2*Math.PI&&(a-=2*Math.PI),t%(.5*n)==0&&(s*=1.05,s>800&&(s=220))}return i}function generateFallbackAudio(e){const t=e.sampleRate,n=10*t,o=e.createBuffer(1,n,t),i=o.getChannelData(0),r=[261.63,293.66,329.63,349.23,392,440,493.88,523.25];let s=0,a=0;for(let e=0;e<n;e++){const n=r[s],o=Math.sin(a)>0?.2:-.2;i[e]=o,a+=2*Math.PI*n/t,a>=2*Math.PI&&(a-=2*Math.PI),e%Math.floor(1.25*t)===0&&(s=(s+1)%r.length)}return o}function generateFallbackSidAudio(e){try{const e=generateFallbackAudio(window.RetroSound.audioContext);window.RetroSound.sidPlayer.currentSid=e}catch(e){}}function playSidMusic(){try{if(window.sidPlayer&&"function"==typeof window.sidPlayer.play)return void window.sidPlayer.play();if(!window.RetroSound.sidPlayer.currentSid)return;const e=window.RetroSound.audioContext;"suspended"===e.state&&e.resume(),window.RetroSound.sidPlayer.audioSource&&window.RetroSound.sidPlayer.audioSource.stop();const t=e.createBufferSource();t.buffer=window.RetroSound.sidPlayer.currentSid;const n=e.createGain();n.gain.setValueAtTime(.5,e.currentTime),t.connect(n),n.connect(e.destination),t.loop=!0,t.start(),window.RetroSound.sidPlayer.audioSource=t,window.RetroSound.sidPlayer.gainNode=n,window.RetroSound.sidPlayer.isPlaying=!0,window.RetroSound.sidPlayer.isPaused=!1}catch(e){}}function stopSidMusic(){try{if(window.sidPlayer&&"function"==typeof window.sidPlayer.stop)return void window.sidPlayer.stop();window.RetroSound.sidPlayer.audioSource&&(window.RetroSound.sidPlayer.audioSource.stop(),window.RetroSound.sidPlayer.audioSource=null),window.RetroSound.sidPlayer.gainNode=null,window.RetroSound.sidPlayer.isPlaying=!1,window.RetroSound.sidPlayer.isPaused=!1}catch(e){}}function pauseSidMusic(){try{if(window.sidPlayer&&"function"==typeof window.sidPlayer.pause)return void window.sidPlayer.pause();if(window.RetroSound.sidPlayer.isPlaying&&!window.RetroSound.sidPlayer.isPaused){if(window.RetroSound.sidPlayer.gainNode){const e=window.RetroSound.audioContext;window.RetroSound.sidPlayer.gainNode.gain.linearRampToValueAtTime(0,e.currentTime+.1),setTimeout(()=>{window.RetroSound.sidPlayer.audioSource&&(window.RetroSound.sidPlayer.audioSource.stop(),window.RetroSound.sidPlayer.audioSource=null),window.RetroSound.sidPlayer.isPaused=!0,window.RetroSound.sidPlayer.isPlaying=!1},100)}}else window.RetroSound.sidPlayer.isPaused&&playSidMusic()}catch(e){}}window.RetroSound.initAudio=function(){if(!window.RetroSound.audioContext)try{window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext),window.RetroSound.floppyAudio||(window.RetroSound.floppyAudio=new Audio("/floppy.mp3"),window.RetroSound.floppyAudio.preload="auto"),document.addEventListener("click",function(){window.RetroSound.audioContext&&"suspended"===window.RetroSound.audioContext.state&&window.RetroSound.audioContext.resume().then(()=>{window.RetroSound.floppyUnlocked=!0})},{once:!0})}catch(e){}},window.RetroSound.initAudio(),window.RetroSound.initSpeech=initSpeech,window.RetroSound.speakText=speakText,window.RetroSound.playBeep=playBeep,window.RetroSound.playFloppySound=playFloppySound,window.RetroSound.unlockAudio=unlockAudio,window.RetroSound.initAudio=window.RetroSound.initAudio,window.RetroSound.playSound=playSound,window.RetroSound.isSpeechActive=isSpeechActive,window.RetroSound.onSpeechEnd=onSpeechEnd,window.RetroSound.clearSpeechEndCallbacks=clearSpeechEndCallbacks,window.RetroSound.forceBrowserSpeech=forceBrowserSpeech,window.RetroSound.speakTextWithID=speakTextWithID,window.RetroSound.sendSpeechDone=sendSpeechDone,window.RetroSound.getWebSocket=getWebSocketInstance,window.RetroSound.playNoise=playNoiseSimple,window.RetroSound.playNoiseComplex=playNoiseComplex,window.RetroSound.playNoiseSimple=playNoiseSimple,window.RetroSound.openSidMusic=openSidMusic,window.RetroSound.playSidMusic=playSidMusic,window.RetroSound.stopSidMusic=stopSidMusic,window.RetroSound.pauseSidMusic=pauseSidMusic,document.addEventListener("click",function(){window.RetroSound&&window.RetroSound.audioContext&&"suspended"===window.RetroSound.audioContext.state&&window.RetroSound.audioContext.resume().then(()=>{}).catch(e=>{})}),document.addEventListener("keydown",function(){window.RetroSound&&window.RetroSound.audioContext&&"suspended"===window.RetroSound.audioContext.state&&window.RetroSound.audioContext.resume().then(()=>{}).catch(e=>{})}),window.RetroSound.sidPlayer={currentSid:null,isPlaying:!1,isPaused:!1,audioSource:null,gainNode:null},function(){"use strict";let e=null,t=!1,n=!1,o="",i=null,r=null,s=null,a=!1,l="normal",c=!1;function d(){return new Promise((e,t)=>{if(c&&window.jsSID)return void e();const n=document.createElement("script");n.onload=()=>{c=!0,e()},n.onerror=()=>{console.warn("Failed to load local jsSID, using fallback..."),new Promise(e=>{window.jsSID={SIDPlayer:class{constructor(){this.isLoaded=!1,this.sampleRate=44100,this.channels=3,this.voices=[{freq:440,wave:"sawtooth",volume:0},{freq:554,wave:"pulse",volume:0},{freq:659,wave:"triangle",volume:0}],this.phase=[0,0,0]}loadSID(e){this.isLoaded=!0;const t=Array.from(e.slice(0,32));return this.voices[0].freq=220+(t[0]||0),this.voices[1].freq=330+(t[1]||0),this.voices[2].freq=440+(t[2]||0),!0}generateSamples(e,t){if(this.isLoaded)for(let n=0;n<t;n++){let t=0;for(let e=0;e<this.channels;e++){const n=this.voices[e];if(n.volume>0){const o=2*n.freq*Math.PI/this.sampleRate;let i=0;switch(n.wave){case"sawtooth":i=this.phase[e]/Math.PI-1;break;case"pulse":i=this.phase[e]<Math.PI?1:-1;break;case"triangle":i=this.phase[e]<Math.PI?this.phase[e]/Math.PI*2-1:1-(this.phase[e]-Math.PI)/Math.PI*2;break;default:i=Math.sin(this.phase[e])}t+=i*n.volume*.2,this.phase[e]+=o,this.phase[e]>2*Math.PI&&(this.phase[e]-=2*Math.PI)}}e[n]=t}}play(){this.voices[0].volume=.8,this.voices[1].volume=.6,this.voices[2].volume=.4}stop(){this.voices.forEach(e=>e.volume=0)}}},c=!0,e()}).then(e).catch(t)},n.src="/js/jsSID.js",document.head.appendChild(n)})}function u(){function c(){if(r||!i||!e)return;"suspended"===i.state&&i.resume();const n=2048,o=console.warn;console.warn=function(e){"string"==typeof e&&e.includes("ScriptProcessorNode")||o.apply(console,arguments)},r=i.createScriptProcessor(n,0,2),console.warn=o;let a=!1;r.onaudioprocess=function(o){if(a||!t||!e){const e=o.outputBuffer.getChannelData(0),t=o.outputBuffer.getChannelData(1);return e.fill(0),void t.fill(0)}a=!0;try{const t=o.outputBuffer.getChannelData(0),i=o.outputBuffer.getChannelData(1);if(e.generateSamples){const o=new Float32Array(n);e.generateSamples(o,n);for(let e=0;e<n;e++)t[e]=o[e],i[e]=o[e]}else t.fill(0),i.fill(0)}catch(e){console.warn("SID audio processing error:",e);const t=o.outputBuffer.getChannelData(0),n=o.outputBuffer.getChannelData(1);t.fill(0),n.fill(0)}finally{a=!1}},r.connect(s)}function u(){if(r){try{r.disconnect()}catch(e){console.warn("AudioNode already disconnected:",e)}r=null}}window.RetroSound||(window.RetroSound={}),i=new(window.AudioContext||window.webkitAudioContext),s=i.createGain(),s.gain.setValueAtTime(.5,i.currentTime),s.connect(i.destination),d().then(()=>{console.log("[SID-PLAYER] SID Player initialized successfully")}).catch(e=>{console.error("[SID-PLAYER] Failed to initialize SID Player:",e)}),window.RetroSound.openSidMusic=function(t){return e&&window.RetroSound.stopSidMusic(),d().then(()=>async function(t){try{const n=[`/api/file?path=${encodeURIComponent(t)}`,`/api/file?path=${encodeURIComponent(t+".sid")}`,`/api/file?path=examples/${encodeURIComponent(t)}`,`/api/file?path=examples/${encodeURIComponent(t+".sid")}`,`/examples/${t}`,`/examples/${t}.sid`];let o=null,i=null;for(const e of n)try{const t=await fetch(e);if(t.ok){o=await t.arrayBuffer(),i=e;break}}catch(e){}if(!o)return console.error(`SID file not found: ${t}`),!1;if(e){try{e.stop()}catch(e){console.warn("Error stopping old SID player:",e)}e=null}e=new window.jsSID(4096,5e-4);const r=new Blob([o],{type:"application/octet-stream"}),s=URL.createObjectURL(r);return e.loadstart(s,0),setTimeout(()=>URL.revokeObjectURL(s),1e3),!0}catch(e){return console.error("Error loading SID file:",e),!1}}(t).then(e=>(e?o=t:console.error(`Failed to load SID music: ${t}`),e)))},window.RetroSound.playSidMusic=function(){e?n?(c(),n=!1,t=!0):t||(e.play(),c(),t=!0):console.warn("No SID music loaded. Use MUSIC OPEN first.")},window.RetroSound.stopSidMusic=function(){e&&(e.stop(),u(),t=!1,n=!1,e=null,o="")},window.RetroSound.setAudioPriority=function(e){l=e},window.RetroSound.setGraphicsIntensiveMode=function(e){a=e,e?window.RetroSound.setAudioPriority("high"):window.RetroSound.setAudioPriority("normal")},window.RetroSound.pauseSidMusic=function(){t&&(u(),t=!1,n=!0)},window.RetroSound.resumeSidMusic=function(){n&&e&&(c(),n=!1,t=!0)},window.RetroSound.isSidMusicPlaying=function(){return t},window.RetroSound.getSidMusicInfo=function(){return{filename:o,isPlaying:t,isPaused:n,currentTime:0,duration:0}}}window.sidPlayer={loadSID:function(e,t){return window.RetroSound.openSidMusic(t||"unknown.sid")},stop:function(){return window.RetroSound.stopSidMusic()},pause:function(){return window.RetroSound.pauseSidMusic()},resume:function(){return window.RetroSound.resumeSidMusic()},isPlaying:function(){return t}},window.addEventListener("beforeunload",function(){window.RetroSound&&window.RetroSound.stopSidMusic&&window.RetroSound.stopSidMusic()}),document.addEventListener("click",function(){i&&"suspended"===i.state&&i.resume()},{once:!0}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u):u()}();const ANSI_GREEN_COLORS={black:"#001100",red:"#004400",green:"#00aa00",yellow:"#00cc44",blue:"#006666",magenta:"#004466",cyan:"#00aaaa",white:"#00ff55",brightBlack:"#003300",brightRed:"#006600",brightGreen:"#00ff00",brightYellow:"#88ff44",brightBlue:"#00aacc",brightMagenta:"#4488cc",brightCyan:"#44ffaa",brightWhite:"#aaffaa",bgBlack:"#000000",bgRed:"#002200",bgGreen:"#004400",bgYellow:"#006622",bgBlue:"#003333",bgMagenta:"#002244",bgCyan:"#004444",bgWhite:"#006644"};class ANSIParser{constructor(){this.reset()}reset(){this.currentForeground=ANSI_GREEN_COLORS.white,this.currentBackground=ANSI_GREEN_COLORS.bgBlack,this.bold=!1,this.dim=!1,this.italic=!1,this.underline=!1,this.blink=!1,this.reverse=!1,this.hidden=!1,this.strikethrough=!1,this.cursorVisible=!0}parseText(e){const t=[];let n=0;const o=/\x1b\[(\??)([0-9;]*?)([A-Za-z])/g;let i;for(;null!==(i=o.exec(e));){const o=e.substring(n,i.index);o&&t.push({text:o,style:this.getCurrentStyle()});const r="?"===i[1];let s=i[2]?i[2].split(";").map(e=>parseInt(e)||0):[0];const a=i[3];r&&s.length>0&&(s=s.map(e=>e+1e3)),this.processANSICommand(s,a),n=i.index+i[0].length}const r=e.substring(n);return r&&t.push({text:r,style:this.getCurrentStyle()}),t}parse(e){const t=[],n=[],o=e.split(/\r\n|\r|\n/);for(let e=0;e<o.length;e++){const i=o[e];this.extractTerminalCommands(i,n);const r=this.parseText(i),s={text:this.extractPlainText(i),segments:r,raw:i};t.push(s)}return{lines:t,commands:n}}processANSICommand(e,t){switch(t){case"m":this.processSGR(e);break;case"K":case"J":case"H":case"f":case"A":case"B":case"C":case"D":case"s":case"u":case"S":case"T":case"L":case"M":case"P":case"@":case"X":case"G":case"`":case"d":case"n":default:break;case"h":case"l":this.processPrivateMode(e,t)}}processPrivateMode(e,t){if(e.length>0&&e[0]>=1e3){if(25===e[0]%1e3)this.cursorVisible="h"===t}}processSGR(e){0===e.length&&(e=[0]);for(let t=0;t<e.length;t++){switch(e[t]){case 0:this.reset();break;case 1:this.bold=!0;break;case 2:this.dim=!0;break;case 3:this.italic=!0;break;case 4:this.underline=!0;break;case 5:case 6:this.blink=!0;break;case 7:this.reverse=!0;break;case 8:this.hidden=!0;break;case 9:this.strikethrough=!0;break;case 22:this.bold=!1,this.dim=!1;break;case 23:this.italic=!1;break;case 24:this.underline=!1;break;case 25:this.blink=!1;break;case 27:this.reverse=!1;break;case 28:this.hidden=!1;break;case 29:this.strikethrough=!1;break;case 30:this.currentForeground=ANSI_GREEN_COLORS.black;break;case 31:this.currentForeground=ANSI_GREEN_COLORS.red;break;case 32:this.currentForeground=ANSI_GREEN_COLORS.green;break;case 33:this.currentForeground=ANSI_GREEN_COLORS.yellow;break;case 34:this.currentForeground=ANSI_GREEN_COLORS.blue;break;case 35:this.currentForeground=ANSI_GREEN_COLORS.magenta;break;case 36:this.currentForeground=ANSI_GREEN_COLORS.cyan;break;case 37:case 39:this.currentForeground=ANSI_GREEN_COLORS.white;break;case 40:case 49:this.currentBackground=ANSI_GREEN_COLORS.bgBlack;break;case 41:this.currentBackground=ANSI_GREEN_COLORS.bgRed;break;case 42:this.currentBackground=ANSI_GREEN_COLORS.bgGreen;break;case 43:this.currentBackground=ANSI_GREEN_COLORS.bgYellow;break;case 44:this.currentBackground=ANSI_GREEN_COLORS.bgBlue;break;case 45:this.currentBackground=ANSI_GREEN_COLORS.bgMagenta;break;case 46:this.currentBackground=ANSI_GREEN_COLORS.bgCyan;break;case 47:this.currentBackground=ANSI_GREEN_COLORS.bgWhite;break;case 90:this.currentForeground=ANSI_GREEN_COLORS.brightBlack;break;case 91:this.currentForeground=ANSI_GREEN_COLORS.brightRed;break;case 92:this.currentForeground=ANSI_GREEN_COLORS.brightGreen;break;case 93:this.currentForeground=ANSI_GREEN_COLORS.brightYellow;break;case 94:this.currentForeground=ANSI_GREEN_COLORS.brightBlue;break;case 95:this.currentForeground=ANSI_GREEN_COLORS.brightMagenta;break;case 96:this.currentForeground=ANSI_GREEN_COLORS.brightCyan;break;case 97:this.currentForeground=ANSI_GREEN_COLORS.brightWhite;break;case 38:if(t+1<e.length)if(5===e[t+1])t+=2,t<e.length&&(this.currentForeground=this.convert256ToGreen(e[t]));else if(2===e[t+1]&&(t+=4,t<e.length)){const n=e[t-2]||0,o=e[t-1]||0,i=e[t]||0;this.currentForeground=this.convertRGBToGreen(n,o,i)}break;case 48:if(t+1<e.length)if(5===e[t+1])t+=2,t<e.length&&(this.currentBackground=this.convert256ToGreen(e[t],!0));else if(2===e[t+1]&&(t+=4,t<e.length)){const n=e[t-2]||0,o=e[t-1]||0,i=e[t]||0;this.currentBackground=this.convertRGBToGreen(n,o,i,!0)}}}}convert256ToGreen(e,t=!1){const n=Math.floor(e%256/255*15),o=Math.max(0,Math.min(255,17*n));return t?`rgb(0, ${Math.floor(o/4)}, 0)`:`rgb(0, ${o}, ${Math.floor(o/2)})`}convertRGBToGreen(e,t,n,o=!1){const i=Math.floor(.299*e+.587*t+.114*n);return o?`rgb(0, ${Math.floor(i/4)}, 0)`:`rgb(0, ${i}, ${Math.floor(i/2)})`}getCurrentStyle(){let e=this.currentForeground,t=this.currentBackground;return this.reverse&&([e,t]=[t,e]),this.bold&&(e=this.brightenColor(e)),this.dim&&(e=this.darkenColor(e)),{color:e,backgroundColor:t,fontWeight:this.bold?"bold":"normal",fontStyle:this.italic?"italic":"normal",textDecoration:[this.underline?"underline":"",this.strikethrough?"line-through":""].filter(e=>e).join(" ")||"none",opacity:this.hidden?0:1,animation:this.blink?"ansi-blink 1s infinite":"none",cursorVisible:this.cursorVisible}}brightenColor(e){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t){return`rgb(${Math.min(255,parseInt(t[1])+40)}, ${Math.min(255,parseInt(t[2])+40)}, ${Math.min(255,parseInt(t[3])+20)})`}return e}darkenColor(e){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t){return`rgb(${Math.max(0,parseInt(t[1])-20)}, ${Math.max(0,parseInt(t[2])-20)}, ${Math.max(0,parseInt(t[3])-10)})`}return e}extractTerminalCommands(e,t){const n=/\x1b\[(\??)([0-9;]*?)([A-Za-z])/g;let o;for(;null!==(o=n.exec(e));){const e="?"===o[1];let n=o[2]?o[2].split(";").map(e=>parseInt(e)||0):[0];const i=o[3];switch(i){case"H":case"f":const o=(n[0]||1)-1,r=(n[1]||1)-1;t.push({type:"cursor",action:"position",row:o,col:r});break;case"J":const s=n[0]||0;0===s?t.push({type:"clear",action:"toEnd"}):1===s?t.push({type:"clear",action:"toStart"}):2===s&&t.push({type:"clear",action:"all"});break;case"K":const a=n[0]||0;0===a?t.push({type:"clearLine",action:"toEnd"}):1===a?t.push({type:"clearLine",action:"toStart"}):2===a&&t.push({type:"clearLine",action:"all"});break;case"A":t.push({type:"cursor",action:"up",count:n[0]||1});break;case"B":t.push({type:"cursor",action:"down",count:n[0]||1});break;case"C":t.push({type:"cursor",action:"right",count:n[0]||1});break;case"D":t.push({type:"cursor",action:"left",count:n[0]||1});break;case"h":case"l":if(e)for(const e of n)switch(e){case 25:t.push({type:"cursor",action:"visibility",visible:"h"===i});break;case 1:t.push({type:"mode",action:"cursorKeys",application:"h"===i});break;case 7:t.push({type:"mode",action:"autoWrap",enabled:"h"===i});break;case 47:case 1047:case 1049:t.push({type:"screen",action:"alternate",enabled:"h"===i})}break;case"s":t.push({type:"cursor",action:"save"});break;case"u":t.push({type:"cursor",action:"restore"})}}}handleTerminalQuery(e,t){if(e.includes("6n")){const e=`[${(t.getCurrentRow?.()||0)+1};${(t.getCurrentCol?.()||0)+1}R`;return t.sendResponse?.(e),!0}if(e.includes("0c")||"[c"===e){const e="[?1;2c";return t.sendResponse?.(e),!0}if(e.includes(">0c")||e.includes(">c")){const e="[>0;95;0c";return t.sendResponse?.(e),!0}if(e.includes("x")){const e="[2;1;1;120;120;1;0x";return t.sendResponse?.(e),!0}if(e.includes(">q")){const e="P>|ANSI Terminal\\";return t.sendResponse?.(e),!0}if(e.includes("?")){if(e.includes("?25h"))return this.cursorVisible=!0,!0;if(e.includes("?25l"))return this.cursorVisible=!1,!0;if(e.includes("?1049h")||e.includes("?1049l"))return!0;if(e.includes("?1h")||e.includes("?1l"))return!0;if(e.includes("?47h")||e.includes("?47l"))return!0;if(e.includes("?7h")||e.includes("?7l"))return!0}return!!e.includes("]")}extractPlainText(e){return e.replace(/\x1b\[(\??)([0-9;]*?)([A-Za-z@`])/g,"").replace(/\x1b\[[0-9;]*[A-Za-z@`]/g,"").replace(/\x1b\][^\x07\x1b]*(\x07|\x1b\\)/g,"").replace(/\x1b[()][AB012]/g,"").replace(/\x1b[78]/g,"")}isCursorVisible(){return this.cursorVisible}getState(){return{foreground:this.currentForeground,background:this.currentBackground,bold:this.bold,dim:this.dim,italic:this.italic,underline:this.underline,blink:this.blink,reverse:this.reverse,hidden:this.hidden,strikethrough:this.strikethrough,cursorVisible:this.cursorVisible}}static getSupportedSequences(){return{cursor:{"ESC[?25h":"Show cursor (DECTCEM)","ESC[?25l":"Hide cursor (DECTCEM)","ESC[H":"Cursor home position","ESC[row;colH":"Set cursor position","ESC[A":"Cursor up","ESC[B":"Cursor down","ESC[C":"Cursor right","ESC[D":"Cursor left","ESC[s":"Save cursor position","ESC[u":"Restore cursor position","ESC[G":"Cursor horizontal absolute","ESC[d":"Line position absolute"},erase:{"ESC[J":"Clear display (0=to end, 1=to start, 2=all)","ESC[K":"Clear line (0=to end, 1=to start, 2=all)","ESC[X":"Erase characters"},text:{"ESC[m":"Reset all text attributes","ESC[1m":"Bold text","ESC[3m":"Italic text","ESC[4m":"Underline text","ESC[5m":"Blinking text","ESC[7m":"Reverse video","ESC[30-37m":"Foreground colors","ESC[40-47m":"Background colors","ESC[90-97m":"Bright foreground colors"},modes:{"ESC[?1h/l":"Application cursor keys mode","ESC[?7h/l":"Auto wrap mode","ESC[?47h/l":"Alternate screen buffer","ESC[?1047h/l":"Alternate screen buffer (xterm)","ESC[?1049h/l":"Alternate screen buffer with save/restore"},scroll:{"ESC[S":"Scroll up","ESC[T":"Scroll down","ESC[L":"Insert lines","ESC[M":"Delete lines"},queries:{"ESC[6n":"Cursor position report","ESC[c":"Device attributes","ESC[>c":"Secondary device attributes","ESC[n":"Device status report"}}}}window.ANSIParser=ANSIParser;class AuthManager{constructor(){this.baseUrl=window.location.origin,this.token=this.getStoredToken(),this.sessionId=this.getStoredSessionId(),this.clearTemporaryTokenOnRefresh()}getStoredToken(){try{return localStorage.getItem("tinyos_token")}catch(e){return console.warn("[AUTH] localStorage not available, using memory storage"),null}}setStoredToken(e){try{e?localStorage.setItem("tinyos_token",e):localStorage.removeItem("tinyos_token")}catch(e){console.warn("[AUTH] localStorage not available for token storage")}this.token=e}getStoredSessionId(){try{return localStorage.getItem("tinyos_session_id")}catch(e){return console.warn("[AUTH] localStorage not available, using memory storage"),null}}setStoredSessionId(e){try{e?localStorage.setItem("tinyos_session_id",e):localStorage.removeItem("tinyos_session_id")}catch(e){console.warn("[AUTH] localStorage not available for session ID storage")}this.sessionId=e}clearTemporaryTokenOnRefresh(){if(!this.token)return!1;try{const e=this.token.split(".");if(3!==e.length)return!1;const t=JSON.parse(atob(e[1]));if(t&&"dyson"===t.username)return console.log("[AUTH] Clearing temporary user token and session on browser refresh"),this.setStoredToken(null),this.setStoredSessionId(null),!0}catch(e){return this.setStoredToken(null),this.setStoredSessionId(null),!0}return!1}async initialize(){if(console.log("[AUTH] Initializing authentication..."),this.token){if(await this.validateToken())return console.log("[AUTH] Existing token is valid"),!0}console.log("[AUTH] No valid token found, creating new session...");const e=await this.createSession();if(!e)return console.error("[AUTH] Failed to create session"),!1;return await this.login(e)?(console.log("[AUTH] Successfully authenticated with new session"),!0):(console.error("[AUTH] Failed to authenticate with new session"),!1)}async createSession(){try{const e=await fetch(`${this.baseUrl}/api/auth/session`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({})}),t=await e.json();return t.success?(console.log("[AUTH] Session created:",t.sessionId),t.sessionId):(console.error("[AUTH] Session creation failed:",t.message),null)}catch(e){return console.error("[AUTH] Session creation error:",e),null}}async login(e){console.log("[AUTH] Logging in with session:",e);try{const t=await fetch(`${this.baseUrl}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({sessionId:e})}),n=await t.json();return n.success?(this.setStoredToken(n.token),this.setStoredSessionId(n.sessionId),console.log("[AUTH] Login successful, token stored"),!0):(console.error("[AUTH] Login failed:",n.message),!1)}catch(e){return console.error("[AUTH] Login error:",e),!1}}async validateToken(){try{const e=await fetch(`${this.baseUrl}/api/auth/validate`,{method:"GET",credentials:"include",headers:{Authorization:this.token?`Bearer ${this.token}`:""}}),t=await e.json();return t.success?(this.setStoredSessionId(t.sessionId),console.log("[AUTH] Token validated for session:",this.sessionId),!0):(console.log("[AUTH] Token validation failed:",t.message),this.setStoredToken(null),this.setStoredSessionId(null),!1)}catch(e){return console.error("[AUTH] Token validation error:",e),this.setStoredToken(null),this.setStoredSessionId(null),!1}}async logout(){console.log("[AUTH] Logging out...");try{await fetch(`${this.baseUrl}/api/auth/logout`,{method:"POST",credentials:"include"})}catch(e){console.error("[AUTH] Logout error:",e)}this.setStoredToken(null),this.setStoredSessionId(null),console.log("[AUTH] Logged out")}getSessionId(){return this.sessionId}getToken(){return this.token}isAuthenticated(){return null!==this.token&&null!==this.sessionId}getWebSocketUrl(){const e="https:"===window.location.protocol?"wss:":"ws:",t=window.location.host;return this.token?`${e}//${t}/ws?token=${encodeURIComponent(this.token)}`:this.sessionId?`${e}//${t}/ws?sessionId=${encodeURIComponent(this.sessionId)}`:`${e}//${t}/ws`}}if(window.authManager=new AuthManager,!CFG)throw new Error("CRT_CONFIG is not defined on window. Please define window.CRT_CONFIG before loading retroconsole.js");const requiredCfgKeys=["SCREEN_PADDING_LEFT","SCREEN_PADDING_TOP","SCREEN_PADDING_RIGHT","SCREEN_PADDING_BOTTOM","VIRTUAL_CRT_WIDTH","VIRTUAL_CRT_HEIGHT","FONT_SIZE_PX","FONT_FAMILY","TEXT_ROWS","TEXT_COLS"];for(const e of requiredCfgKeys)if(void 0===CFG[e])throw new Error(`CRT_CONFIG is missing required property: ${e}`);const RESPONSE_TYPE_MAP={0:"TEXT",1:"CLEAR",2:"BEEP",3:"SPEAK",4:"GRAPHICS",5:"SOUND",6:"SPEAK_DONE",7:"MODE",8:"SESSION",9:"INPUT_CONTROL",10:"SPRITE",11:"VECTOR",12:"PROMPT",13:"NOISE",14:"INPUT",15:"CHAT",16:"KEY_DOWN",17:"KEY_UP",18:"LOCATE",19:"INVERSE",20:"EDITOR",21:"PAGER",23:"TELNET",24:"AUTO_EXECUTE",25:"BITMAP",26:"EVIL"};window.RetroConsole||(window.RetroConsole={}),Object.assign(window.RetroConsole,{lines:["SKYNET COMPUTERS INC.","TERMINAL READY",""],inverseLines:[[],[],[]],promptSymbol:"> ",input:"",cursorPos:0,inputEnabled:!0,inputMode:0,runMode:!1,passwordMode:!1,pagerMode:!1,terminalStatus:"",telnetMode:!1,pagerPrompt:"",telnetEchoBuffer:[],telnetServerEcho:!1,chatMode:!1,cursorX:0,cursorY:0,locateMode:!1,screenBuffer:null,inverseMode:!1,textCanvas:null,_textCanvasDirty:!0,_cursorBlinkInterval:null,_lastCursorState:!1,isTextCanvasDirty:function(){const e=this.inputEnabled&&!this.forcedHideCursor&&Math.floor(Date.now()/500)%2==0;return this._textCanvasDirty||e!==this._lastCursorState},markTextCanvasClean:function(){this._textCanvasDirty=!1,this._lastCursorState=this.inputEnabled&&!this.forcedHideCursor&&Math.floor(Date.now()/500)%2==0},textTexture:null,startCursorBlink:function(){null===this._cursorBlinkInterval&&(this._cursorBlinkInterval=setInterval(()=>{!this.inputEnabled||this.editorMode||this.filenameInputMode||this.drawTerminal()},500))},stopCursorBlink:function(){null!==this._cursorBlinkInterval&&(clearInterval(this._cursorBlinkInterval),this._cursorBlinkInterval=null,this.drawTerminal())},CHAR_WIDTH:10,CHAR_HEIGHT:20,debugMode:!1,editorMode:!1,editorLines:[],editorCursorLine:0,editorCursorCol:0,editorScrollLine:0,editorAbsCursorLine:0,editorFilename:"",editorModified:!1,editorStatus:"",editorRows:24,editorCols:80,editorData:null,chessHelpText:"",filenameInputMode:!1,filenameInput:"",filenamePrompt:"",editorStatus:"",editorRows:24,editorCols:80,editorData:null,terminalLinesBackup:[],terminalInverseLinesBackup:[],terminalScreenBufferBackup:null,initTextCanvas:function(){if(this.textCanvas)return;this.textCanvas=document.createElement("canvas"),this.textCanvas.width=CFG.VIRTUAL_CRT_WIDTH,this.textCanvas.height=CFG.VIRTUAL_CRT_HEIGHT;const e=this.textCanvas.getContext("2d");e&&(e.imageSmoothingEnabled=!1),"undefined"!=typeof THREE&&(this.textTexture=new THREE.CanvasTexture(this.textCanvas),this.textTexture.minFilter=THREE.NearestFilter,this.textTexture.magFilter=THREE.NearestFilter,this.textTexture.flipY=!1),this.updateCharMetrics()},wrapText:function(e,t){if(!e)return[""];for(var n=e.split("\n"),o=[],i=0;i<n.length;i++){var r=n[i];if(r.length<=t)o.push(r);else for(var s=r;s.length>0;){if(s.length<=t){o.push(s);break}var a=t,l=s.lastIndexOf(" ",t);l>.75*t?(a=l,o.push(s.substring(0,a)),s=s.substring(a+1)):(o.push(s.substring(0,a)),s=s.substring(a))}}return o},updateCharMetrics:function(){const e=window.CRT_CONFIG;this.CHAR_PADDING_X=e.SCREEN_PADDING_LEFT;const t=e.SCREEN_PADDING_LEFT+e.SCREEN_PADDING_RIGHT;this.CHAR_PADDING_Y=e.SCREEN_PADDING_TOP;const n=e.SCREEN_PADDING_TOP+e.SCREEN_PADDING_BOTTOM,o=e.VIRTUAL_CRT_WIDTH-t,i=e.VIRTUAL_CRT_HEIGHT-n;this.CHAR_WIDTH=o/e.TEXT_COLS,this.cursorAdvanceRate=o/e.TEXT_COLS,this.CHAR_HEIGHT=i/e.TEXT_ROWS,this.CHAR_FONT_SIZE=e.FONT_SIZE_PX},setCanvasAndTexture:function(e,t){if(e&&t){if(this.textCanvas=e,this.textTexture=t,this.textCanvas){const e=this.textCanvas.getContext("2d");e&&(e.imageSmoothingEnabled=!1)}this.updateCharMetrics()}},checkAndScroll:function(){const e=CFG.TEXT_ROWS,t=this.lines.length;if(t>=e){const n=t-e+1;if(this.lines.splice(0,n),this.inverseLines.splice(0,n),this.screenBuffer){this.screenBuffer.splice(0,n);for(let e=0;e<n;e++)this.screenBuffer.push(Array(CFG.TEXT_COLS).fill({char:" ",inverse:!1}))}}},drawTerminal:function(){if(this.editorMode)return;if(!this.textCanvas)return;const e=this.textCanvas.getContext("2d");if(!e)return;e.imageSmoothingEnabled=!1,e.fillStyle="#000000",e.fillRect(0,0,this.textCanvas.width,this.textCanvas.height);const t=CFG.SCREEN_PADDING_LEFT,n=CFG.SCREEN_PADDING_TOP;e.font=`${this.CHAR_FONT_SIZE}px ${CFG.FONT_FAMILY}`,e.fillStyle=CFG.BRIGHTNESS_LEVELS[15],e.textBaseline="top",this.ACTUAL_CHAR_WIDTH=this.CHAR_WIDTH;const o=CFG.TEXT_ROWS-1;this.lines||(this.lines=[]),this.inverseLines||(this.inverseLines=[]),this.lines.length;let i,r=this.lines.slice(-o),s=this.inverseLines.slice(-o);if(2!==this.inputMode)for(let o=0;o<r.length;o++){let i=r[o],a=s[o]||[];for(let r=0;r<Math.min(i.length,CFG.TEXT_COLS);r++){const s=i[r],l=!0===a[r],c=t+r*this.CHAR_WIDTH,d=n+o*this.CHAR_HEIGHT;if(l){e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];const t=d-2,n=this.CHAR_HEIGHT-2;e.fillRect(c,t,this.CHAR_WIDTH,n),e.fillStyle="#000000"}else e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];e.fillText(s,c,d)}}if(this.screenBuffer){const o=CFG.TEXT_ROWS-1;for(let i=0;i<Math.min(this.screenBuffer.length,o);i++)for(let o=0;o<Math.min(this.screenBuffer[i].length,CFG.TEXT_COLS);o++){const r=this.screenBuffer[i][o];if(" "!==r.char){const s=t+o*this.CHAR_WIDTH,a=n+i*this.CHAR_HEIGHT;if(r.inverse){e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];const t=a-2,n=this.CHAR_HEIGHT-2;e.fillRect(s,t,this.CHAR_WIDTH,n),e.fillStyle="#000000"}else e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];e.fillText(r.char,s,a),e.fillStyle=CFG.BRIGHTNESS_LEVELS[15]}}}if(2===this.inputMode)i=this.cursorY;else{i=this.lines.slice(-o).length}if(this.telnetMode||2===this.inputMode){if(2===this.inputMode){let o=this.input;this.passwordMode&&(o="*".repeat(this.input.length));const i=t+this.cursorX*this.CHAR_WIDTH,r=n+this.cursorY*this.CHAR_HEIGHT;console.log(`[CHESS-DEBUG] Drawing input at cursorX=${this.cursorX}, cursorY=${this.cursorY}, screenX=${i}, screenY=${r}, input="${o}"`),e.fillStyle=CFG.BRIGHTNESS_LEVELS[15],e.fillText(o,i,r)}}else{let o,r=this.input;this.passwordMode&&(r="*".repeat(this.input.length)),o=this.pagerMode?"":this.runMode?r:this.promptSymbol+r;const s=CFG.TEXT_COLS,a=Math.min(s,o.length);Math.ceil(o.length/s);if(e.fillText(o.substring(0,a),t,n+i*this.CHAR_HEIGHT),o.length>s){const r=o.substring(s);for(let o=0;o<r.length;o+=s){const a=i+1+Math.floor(o/s),l=r.substring(o,o+s);e.fillText(l,t,n+a*this.CHAR_HEIGHT)}}}if(this.screenBuffer){let e=-1;for(let t=0;t<this.screenBuffer.length;t++)for(let n=0;n<this.screenBuffer[t].length;n++)if(this.screenBuffer[t][n]&&" "!==this.screenBuffer[t][n].char){e=t;break}e>=0&&(i=Math.max(i,e+1))}if(this.inputEnabled&&!this.forcedHideCursor){const o=Math.floor(Date.now()/500)%2==0;let r,s;if(this.telnetMode)r=this.cursorX,s=this.cursorY;else if(2===this.inputMode)r=this.cursorX+this.cursorPos,s=this.cursorY,console.log(`[CHESS-DEBUG] Cursor position: cursorX=${this.cursorX}, cursorPos=${this.cursorPos}, cursorCol=${r}, cursorRow=${s}`);else{const e=this.runMode?0:this.promptSymbol.length;r=(e+this.cursorPos)%CFG.TEXT_COLS,s=i+Math.floor((e+this.cursorPos)/CFG.TEXT_COLS)}if(o){let o,i;if(e.save(),e.fillStyle=CFG.BRIGHTNESS_LEVELS[12],this.telnetMode)o=t+r*this.cursorAdvanceRate,i=n+s*this.CHAR_HEIGHT;else if(2===this.inputMode)o=t+(this.cursorX+this.cursorPos)*this.CHAR_WIDTH,i=n+this.cursorY*this.CHAR_HEIGHT;else{const r=(this.runMode?0:this.promptSymbol.length)+this.cursorPos,a=Math.floor(r/CFG.TEXT_COLS)*CFG.TEXT_COLS,l=(this.runMode?this.input:this.promptSymbol+this.input).substring(a,r);o=t+e.measureText(l).width,i=n+s*this.CHAR_HEIGHT}const a=.9*this.cursorAdvanceRate;let l;e.fillRect(o,i,a,.85*this.CHAR_HEIGHT),e.fillStyle="#041208",l=this.telnetMode?" ":this.cursorPos<this.input.length?this.input[this.cursorPos]:" ",e.fillText(l,o,i),e.restore()}}this.textTexture&&(window.RetroGraphics&&window.RetroGraphics.forceTextTextureUpdate&&window.RetroGraphics.forceTextTextureUpdate(),this.textTexture.needsUpdate=!0),(this.telnetMode||this.terminalStatus)&&this.drawTerminalStatusLine(e,t,n)},drawTerminalStatusLine:function(e,t,n){if(!this.terminalStatus)return;const o=n+(CFG.TEXT_ROWS-1)*this.CHAR_HEIGHT;e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];const i=o-2,r=this.CHAR_HEIGHT-2;e.fillRect(t,i,CFG.TEXT_COLS*this.CHAR_WIDTH,r),e.fillStyle="#000000";for(let n=0;n<Math.min(this.terminalStatus.length,CFG.TEXT_COLS);n++){const i=this.terminalStatus[n],r=t+n*this.CHAR_WIDTH;e.fillText(i,r,o)}e.fillStyle=CFG.BRIGHTNESS_LEVELS[15]},handleBackendMessage:function(e){try{let t="string"==typeof e.data?e.data.trim():e.data;if(console.log("[RetroConsole-DEBUG] Received raw backend message:",t),"string"==typeof t&&0===t.length)return void console.log("[FRONTEND-DEBUG] Empty string data received, ignoring.");const n=e=>{const t=RESPONSE_TYPE_MAP[e.type]||"UNKNOWN";return 2===this.inputMode&&console.log(`[CHESS-DEBUG] Received message type ${e.type} (${t}):`,e),"EDITOR"===t?(this.handleEditorMessage(e),!1):(this._processBackendResponse(e,t),!0)};if("string"==typeof t){const e=(t.match(/{/g)||[]).length,o=(t.match(/}/g)||[]).length;if(e>1&&o>1&&t.match(/}\s*{/)){let e=t.split(/}\s*{/).map((e,t,n)=>0===t?e+"}":t===n.length-1?"{"+e:"{"+e+"}"),o=!0;e.forEach(e=>{try{const t=JSON.parse(e);n(t)||(o=!1)}catch(e){}}),o&&this.drawTerminal()}else try{const e=JSON.parse(t);n(e)&&this.drawTerminal()}catch(e){}}else"object"==typeof t&&null!==t&&n(t)&&this.drawTerminal()}catch(e){}},_processBackendResponse:function(e,t){switch(t){case"TEXT":if(!0===e.chessHelp&&void 0!==e.content)return void(this.chessHelpText=String(e.content));if(void 0!==e.content&&null!==e.content){const t=String(e.content);if("BREAK"===t)try{window.RetroSound&&"function"==typeof window.RetroSound.stopSidMusic&&window.RetroSound.stopSidMusic()}catch(e){}if(0===t.trim().length)return;if(this.locateMode&&void 0!==this.cursorX&&void 0!==this.cursorY){const n="boolean"==typeof e.inverse?e.inverse:this.inverseMode;return this.setTextAtPosition(this.cursorX,this.cursorY,t,n),void(this.locateMode=!1)}{const n="boolean"==typeof e.inverse?e.inverse:this.inverseMode;if(e.noNewline)if(this.lines.length>0){const e=this.lines.length-1;this.lines[e]+=t,this.inverseLines[e]||(this.inverseLines[e]=[]);for(let o=0;o<t.length;o++)this.inverseLines[e].push(n)}else this.lines.push(t),this.inverseLines.push(Array(t.length).fill(n));else{const e=this.wrapText(t,CFG.TEXT_COLS);for(let t=0;t<e.length;t++)this.lines.push(e[t]),this.inverseLines.push(Array(e[t].length).fill(n))}}}break;case"CLEAR":this.lines=[],this.inverseLines=[],this.input="",this.cursorPos=0,this.screenBuffer=null,this.locateMode=!1,this.cursorX=0,this.cursorY=0,this.inverseMode=!1,window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleClearScreen&&window.RetroGraphics.handleClearScreen(),window.vectorManager&&"function"==typeof window.vectorManager.renderVectors&&window.persistentGraphicsContext&&window.persistentGraphicsCanvas&&window.vectorManager.renderVectors(window.persistentGraphicsContext,window.persistentGraphicsCanvas.width,window.persistentGraphicsCanvas.height);break;case"PROMPT":"boolean"==typeof e.inputEnabled&&(this.inputEnabled=e.inputEnabled),"string"==typeof e.promptSymbol&&(this.promptSymbol=e.promptSymbol),"reset_cursor"===e.content&&this.lines.push(""),this.drawTerminal();break;case"INPUT":"string"==typeof e.input&&(this.input=e.input),"number"==typeof e.cursorPos&&(this.cursorPos=e.cursorPos);break;case"INPUT_CONTROL":"enable"===e.content?(this.inputEnabled=!0,this.runMode=!1,this.passwordMode=!1,this.startCursorBlink()):"disable"===e.content?(this.inputEnabled=!1,this.stopCursorBlink()):"run_mode"===e.content?(this.inputEnabled=!1,this.runMode=!0,this.stopCursorBlink()):"password_mode_on"===e.content?(this.passwordMode=!0,this.inputEnabled=!0,this.startCursorBlink()):"password_mode_off"===e.content&&(this.passwordMode=!1);break;case"BEEP":window.RetroSound&&"function"==typeof window.RetroSound.playBeep&&window.RetroSound.playBeep();break;case"SPEAK":window.RetroSound&&"function"==typeof window.RetroSound.speakTextWithID&&e.content&&void 0!==e.speechId&&window.RetroSound.speakTextWithID(e.content,e.speechId);break;case"SOUND":if(window.RetroSound&&"function"==typeof window.RetroSound.playSound){let t,n;if(e.params&&"object"==typeof e.params){if(e.params.action){switch(e.params.action){case"music_open":window.RetroSound&&"function"==typeof window.RetroSound.openSidMusic&&window.RetroSound.openSidMusic(e.params.filename);break;case"music_play":window.RetroSound&&"function"==typeof window.RetroSound.playSidMusic&&window.RetroSound.playSidMusic();break;case"music_stop":window.RetroSound&&"function"==typeof window.RetroSound.stopSidMusic&&window.RetroSound.stopSidMusic();break;case"music_pause":window.RetroSound&&"function"==typeof window.RetroSound.pauseSidMusic&&window.RetroSound.pauseSidMusic()}break}if("noise"===e.params.type){const t=e.params.pitch,n=e.params.attack,o=e.params.decay;if(void 0!==t&&void 0!==n&&void 0!==o){window.RetroSound.unlockAudio&&window.RetroSound.unlockAudio();try{"function"==typeof window.RetroSound.playNoiseComplex?window.RetroSound.playNoiseComplex(t,n,o):window.RetroSound.playNoise("white",o)}catch(e){}}break}t=e.params.frequency,n=e.params.duration}else if(e.content)if("beep"===e.content)t=800,n=200;else{if("floppy"===e.content){window.RetroSound&&"function"==typeof window.RetroSound.playFloppySound&&window.RetroSound.playFloppySound();break}{const o=e.content.split(",");2===o.length&&(t=parseFloat(o[0]),n=parseFloat(o[1]))}}if(void 0!==t&&void 0!==n&&!isNaN(t)&&!isNaN(n))try{window.RetroSound.playSound(t,n)}catch(e){}}else window.RetroSound&&"function"==typeof window.RetroSound.playBeep&&window.RetroSound.playBeep();break;case"NOISE":if(window.RetroSound&&"function"==typeof window.RetroSound.playNoise){let t,n,o,i,r;if(e.params&&"object"==typeof e.params){if(void 0!==e.params.pitch&&void 0!==e.params.attack&&void 0!==e.params.decay){if(t=e.params.pitch,n=e.params.attack,o=e.params.decay,void 0!==t&&void 0!==n&&void 0!==o){window.RetroSound.unlockAudio&&window.RetroSound.unlockAudio();try{"function"==typeof window.RetroSound.playNoiseComplex?window.RetroSound.playNoiseComplex(t,n,o):window.RetroSound.playNoise("white",o)}catch(e){}}}else if(i=e.params.type||"white",r=e.params.duration,void 0!==r&&!isNaN(r))try{window.RetroSound.playNoise(i,r)}catch(e){}}else if(e.content)try{const s=e.content.split(",").map(e=>e.trim());3===s.length?(t=parseFloat(s[0]),n=parseFloat(s[1]),o=parseFloat(s[2]),"function"==typeof window.RetroSound.playNoiseComplex?window.RetroSound.playNoiseComplex(t,n,o):window.RetroSound.playNoise("white",o)):2===s.length?(i=s[0]||"white",r=parseFloat(s[1]),window.RetroSound.playNoise(i,r)):1===s.length&&(r=parseFloat(s[0]),window.RetroSound.playNoise("white",r))}catch(e){}}break;case"EVIL":window.RetroGraphics&&"function"==typeof window.RetroGraphics.triggerEvilEffect?window.RetroGraphics.triggerEvilEffect():console.error("[RetroConsole-EVIL] ERROR: Cannot trigger Evil Effect - RetroGraphics or triggerEvilEffect not available!");break;case"MODE":if(void 0!==e.content){switch(String(e.content).toUpperCase()){case"OS_SHELL":default:this.inputMode=0;break;case"BASIC":this.inputMode=1;break;case"CHESS":this.inputMode=2;break;case"EDITOR":this.inputMode=3;break;case"TELNET":this.inputMode=4;break;case"PAGER":this.inputMode=5}}window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleModeChange&&window.RetroGraphics.handleModeChange(e.content);break;case"SESSION":const t=e.sessionId||e.sessionID||e.content;t&&(window.sessionStorage&&window.sessionStorage.setItem("sessionId",t),window.sessionId=t,this.refreshTokenForSession(t),"function"==typeof window.sendTerminalConfig&&setTimeout(window.sendTerminalConfig,100));break;case"SPRITE":if(e.command)switch(e.command){case"DEFINE_SPRITE":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleDefineSprite&&window.RetroGraphics.handleDefineSprite(e);break;case"UPDATE_SPRITE":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleUpdateSprite&&window.RetroGraphics.handleUpdateSprite(e);break;case"DEFINE_VIRTUAL_SPRITE":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleDefineVirtualSprite&&window.RetroGraphics.handleDefineVirtualSprite(e);break;case"CLEAR_ALL_SPRITES":window.RetroGraphics&&"function"==typeof window.RetroGraphics.clearAllSpriteData&&window.RetroGraphics.clearAllSpriteData()}break;case"GRAPHICS":if(e.command){const t={type:e.command,...e.params};switch(e.command){case"PLOT":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handlePlot?window.RetroGraphics.handlePlot(t):this.debugMode&&console.log("[RetroConsole-GRAPHICS] RetroGraphics.handlePlot not available");break;case"LINE":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleLine?window.RetroGraphics.handleLine(t):this.debugMode&&console.log("[RetroConsole-GRAPHICS] RetroGraphics.handleLine not available");break;case"RECT":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleRect?window.RetroGraphics.handleRect(t):this.debugMode&&console.log("[RetroConsole-GRAPHICS] RetroGraphics.handleRect not available");break;case"CIRCLE":this.debugMode&&(console.log("[RetroConsole-CIRCLE] *** CIRCLE command received! ***"),console.log("[RetroConsole-CIRCLE] Graphics command object:",t),console.log("[RetroConsole-CIRCLE] Raw response:",e)),window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleCircle?(this.debugMode&&console.log("[RetroConsole-CIRCLE] Calling RetroGraphics.handleCircle"),window.RetroGraphics.handleCircle(t)):this.debugMode&&(console.log("[RetroConsole-CIRCLE] RetroGraphics.handleCircle not available"),console.log("[RetroConsole-CIRCLE] window.RetroGraphics:",window.RetroGraphics));break;case"FILL":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleFill?window.RetroGraphics.handleFill(t):this.debugMode&&console.log("[RetroConsole-GRAPHICS] RetroGraphics.handleFill not available");break;case"CLEAR_SCREEN":this.lines=[],this.input="",this.cursorPos=0,window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleClearScreen?window.RetroGraphics.handleClearScreen():this.debugMode&&console.log("[RetroConsole-GRAPHICS] RetroGraphics.handleClearScreen not available");break;case"UPDATE_VECTOR":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleUpdateVector?window.RetroGraphics.handleUpdateVector(t):this.debugMode&&console.log("[RetroConsole-GRAPHICS] RetroGraphics.handleUpdateVector not available");break;case"CLEAR_ALL_VECTORS":window.RetroGraphics&&"function"==typeof window.RetroGraphics.clearAllVectors?window.RetroGraphics.clearAllVectors():this.debugMode&&console.log("[RetroConsole-GRAPHICS] RetroGraphics.clearAllVectors not available");break;default:this.debugMode&&console.log("[RetroConsole-GRAPHICS] Unknown graphics command:",e.command)}}else this.debugMode&&console.log("[RetroConsole-GRAPHICS] No command in graphics message");break;case"VECTOR":if(this.debugMode&&console.log("[RetroConsole-VECTOR] Received VECTOR message:",e),e.command)switch(e.command){case"UPDATE_VECTOR":window.RetroGraphics&&"function"==typeof window.RetroGraphics.handleUpdateVector?window.RetroGraphics.handleUpdateVector(e):this.debugMode&&console.log("[RetroConsole-VECTOR] RetroGraphics.handleUpdateVector not available");break;case"CLEAR_ALL_VECTORS":window.RetroGraphics&&"function"==typeof window.RetroGraphics.clearAllVectors?window.RetroGraphics.clearAllVectors():this.debugMode&&console.log("[RetroConsole-VECTOR] RetroGraphics.clearAllVectors not available");break;default:this.debugMode&&console.log("[RetroConsole-VECTOR] Unknown vector command:",e.command)}else this.debugMode&&console.log("[RetroConsole-VECTOR] No command in vector message");break;case"CHAT":this.initiateChatMode();break;case"LOCATE":if(e.content){const t=e.content.split(",");if(2===t.length){const n=Math.max(0,parseInt(t[0])||0),o=Math.max(0,parseInt(t[1])||0);console.log(`[CHESS-DEBUG] LOCATE received: ${e.content} -> setting cursorX=${n}, cursorY=${o} (inputMode=${this.inputMode})`),this.cursorX=n,this.cursorY=o,this.cursorY>=CFG.TEXT_ROWS&&(this.cursorY=CFG.TEXT_ROWS-1),this.cursorX>=CFG.TEXT_COLS&&(this.cursorX=CFG.TEXT_COLS-1),this.locateMode=!0}}break;case"INVERSE":if(void 0!==e.content){const t=String(e.content).toUpperCase();"ON"===t?this.inverseMode=!0:"OFF"===t&&(this.inverseMode=!1)}break;case"PAGER":this.pagerPrompt=e.pagerPrompt||"","activate"===e.content?(this.pagerMode=!0,this.inputEnabled=!1,this.input="",this.cursorPos=0):"deactivate"===e.content&&(this.pagerMode=!1,this.inputEnabled=!0);break;case"CURSOR":"hide"===e.content?(this.forcedHideCursor=!0,this.editorMode&&this.editorData&&(this.editorData.hideCursor=!0)):"show"===e.content&&(this.forcedHideCursor=!1,this.editorMode&&this.editorData&&!this.editorData.readOnly&&(this.editorData.hideCursor=!1)),this.editorMode?this.drawEditor():this.drawTerminal();break;case"TELNET":this.handleTelnetMessage(e);break;case"EDITOR":this.handleEditorMessage(e);break;case"BITMAP":this.handleBitmapMessage(e)}},handleEditorMessage:function(e){switch(this.editorData||"start"===e.editorCommand||"render"===e.editorCommand||(this.editorData={lines:[],filename:"",readOnly:!1,cols:CFG.TEXT_COLS,rows:CFG.TEXT_ROWS,cursorX:0,cursorY:0,scrollY:0,hideCursor:!1,statusText:""}),e.editorCommand){case"start":this.editorMode||(this.terminalLinesBackup=[...this.lines],this.terminalInverseLinesBackup=[...this.inverseLines],this.terminalScreenBufferBackup=this.screenBuffer?JSON.parse(JSON.stringify(this.screenBuffer)):null,this.stopCursorBlink()),this.editorMode=!0;let t=[];if(e.params&&e.params.content){const n=e.params.content;t=n.includes("\r\n")?n.split("\r\n"):n.includes("\n")?n.split("\n"):[n]}else e.content?(console.log('[EDITOR-CONSOLE] "start": Processing message.content, length:',e.content.length),e.content.includes("\\r\\n")?(t=e.content.split("\\r\\n"),console.log('[EDITOR-CONSOLE] "start": Split content on \\r\\n, got',t.length,"lines")):e.content.includes("\\\\r\\\\n")?(t=e.content.split("\\\\r\\\\n"),console.log('[EDITOR-CONSOLE] "start": Split content on \\\\r\\\\n, got',t.length,"lines")):e.content.includes("\n")?(t=e.content.split("\n"),console.log('[EDITOR-CONSOLE] "start": Split content on \\n, got',t.length,"lines")):(t=[e.content],console.log('[EDITOR-CONSOLE] "start": No line breaks found, using single line'))):e.params&&Array.isArray(e.params.lines)&&(t=[...e.params.lines],console.log('[EDITOR-CONSOLE] "start": Using message.params.lines directly, got',t.length,"lines"));this.editorData={lines:t,filename:e.params?.filename||"",readOnly:e.params?.readOnly||!1,cols:e.params?.cols||CFG.TEXT_COLS,rows:e.params?.rows||CFG.TEXT_ROWS,cursorX:e.params?.cursorX??0,cursorY:e.params?.cursorY??0,scrollY:e.params?.scrollY??0,hideCursor:e.params?.hideCursor??!1,statusText:`File: ${e.params?.filename||""} | Ctrl+S Save, Esc Close`},this.lines=[...this.editorData.lines],this.cursorX=this.editorData.cursorX,this.cursorY=this.editorData.cursorY,this.drawEditor(),"function"==typeof window.sendEditorCommand?window.sendEditorCommand("ready",{status:"Editor is ready"}):console.error('[EDITOR-CONSOLE] "start": sendEditorCommand IS NOT available. CANNOT send "ready".');break;case"render":console.log('[EDITOR-CONSOLE] "render": Received render command',e),this.editorData||(console.log('[EDITOR-CONSOLE] "render": Creating new editorData'),this.editorData={lines:[],filename:e.params?.filename||"",readOnly:e.params?.readOnly||!1,cols:e.params?.textCols||CFG.TEXT_COLS,rows:e.params?.textRows||CFG.TEXT_ROWS,cursorX:0,cursorY:0,scrollY:0,hideCursor:!1,statusText:`File: ${e.params?.filename||""} | Ctrl+S Save, Esc Close`,_lastUpdateTime:Date.now()}),e.params&&(console.log('[EDITOR-CONSOLE] "render": Processing render parameters'),"number"==typeof e.params.cursorX&&(this.editorData.cursorX=e.params.cursorX,this.editorData.cursorCol=e.params.cursorX,console.log('[EDITOR-CONSOLE] "render": Stored cursorX/cursorCol =',this.editorData.cursorX)),"number"==typeof e.params.cursorY&&(this.editorData.cursorY=e.params.cursorY,this.editorData.cursorLine=e.params.cursorY,console.log('[EDITOR-CONSOLE] "render": Stored cursorY/cursorLine =',this.editorData.cursorY)),"number"==typeof e.params.visibleCursorCol&&(this.editorData.visibleCursorCol=e.params.visibleCursorCol,console.log('[EDITOR-CONSOLE] "render": Stored visibleCursorCol =',this.editorData.visibleCursorCol)),"number"==typeof e.params.visibleCursorLine&&(this.editorData.visibleCursorLine=e.params.visibleCursorLine,console.log('[EDITOR-CONSOLE] "render": Stored visibleCursorLine =',this.editorData.visibleCursorLine)),"boolean"==typeof e.params.mappingSuccess&&(this.editorData.mappingSuccess=e.params.mappingSuccess,console.log('[EDITOR-CONSOLE] "render": Stored mappingSuccess =',this.editorData.mappingSuccess)),"boolean"==typeof e.params.mappingSuccess&&!1===e.params.mappingSuccess&&(console.warn("[EDITOR-CONSOLE] WARNING: Backend reported cursor mapping failure!"),console.log("[EDITOR-DEBUG] Full message params:",JSON.stringify(e.params))),"number"==typeof e.params.textCols&&(this.editorData.cols=e.params.textCols,console.log('[EDITOR-CONSOLE] "render": Set cols =',this.editorData.cols)),"number"==typeof e.params.textRows&&(this.editorData.rows=e.params.textRows,console.log('[EDITOR-CONSOLE] "render": Set rows =',this.editorData.rows)),"number"==typeof e.params.scrollY&&(this.editorData.scrollY=e.params.scrollY,console.log('[EDITOR-CONSOLE] "render": Set scrollY =',this.editorData.scrollY)),"boolean"==typeof e.params.hideCursor&&(this.editorData.hideCursor=e.params.hideCursor,console.log('[EDITOR-CONSOLE] "render": Set hideCursor =',this.editorData.hideCursor)),e.params.status&&(this.editorData.statusText=e.params.status,console.log('[EDITOR-CONSOLE] "render": Set statusText =',this.editorData.statusText)),e.params.lines&&Array.isArray(e.params.lines)&&(this.editorData.lines=e.params.lines,this.lines=[...this.editorData.lines],console.log('[EDITOR-CONSOLE] "render": Set lines from params.lines, length =',this.editorData.lines.length))),this.cursorX=this.editorData.cursorX,this.cursorY=this.editorData.cursorY,console.log('[EDITOR-CONSOLE] "render": Calling drawEditor'),this.drawEditor();break;case"status":this.editorMode&&this.editorData?(this.editorData.statusText=e.editorStatus||e.statusText||this.editorData.statusText,this.drawEditor()):(this.terminalStatus=e.editorStatus||e.statusText||"",this.drawTerminal());break;case"filename_input":this.stopCursorBlink(),this.startFilenameInput(e);break;case"filename_input_complete":this.stopFilenameInput(),this.startCursorBlink();break;case"stop":this.editorMode=!1,this.filenameInputMode=!1,this.inputEnabled=!0,this.forcedHideCursor=!1,this.lines=[...this.terminalLinesBackup],this.inverseLines=[...this.terminalInverseLinesBackup],this.screenBuffer=this.terminalScreenBufferBackup?JSON.parse(JSON.stringify(this.terminalScreenBufferBackup)):null,this.editorData=null,this.drawTerminal(),this.startCursorBlink()}},drawEditor:function(){if(!this.editorMode||!this.editorData)return void console.warn("[EDITOR-CONSOLE] drawEditor called without editorMode or editorData.");if(!this.textCanvas)return void console.error("[EDITOR-CONSOLE] textCanvas is not available for drawEditor.");const e=this.textCanvas.getContext("2d");if(!e)return void console.error("[EDITOR-CONSOLE] Canvas context is not available for drawEditor.");if(this.debugMode&&this.editorData.debug){let e="";e=void 0!==this.editorData.visibleCursorLine&&void 0!==this.editorData.visibleCursorCol?`Visible Cursor: Line ${this.editorData.visibleCursorLine}, Col ${this.editorData.visibleCursorCol}`:`Original Cursor: Line ${this.editorData.cursorLine}, Col ${this.editorData.cursorCol}`,console.log(`[EDITOR-DEBUG] ${e}, Scroll: ${this.editorData.scrollY}, Total wrapped: ${this.editorData.totalLines}`)}e.imageSmoothingEnabled=!1,e.fillStyle="#000000",e.fillRect(0,0,this.textCanvas.width,this.textCanvas.height);const t=CFG.SCREEN_PADDING_LEFT,n=CFG.SCREEN_PADDING_TOP;e.font=`${this.CHAR_FONT_SIZE}px ${CFG.FONT_FAMILY}`,e.textBaseline="top";const o=this.editorData.rows-1;for(let i=0;i<o;i++)if(i<this.editorData.lines.length){const o=this.editorData.lines[i];let r=Array.from(o||"");e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];for(let o=0;o<Math.min(r.length,this.editorData.cols);o++){const s=r[o];if(null==s)continue;const a=t+o*this.CHAR_WIDTH,l=n+i*this.CHAR_HEIGHT;e.fillText(s,a,l)}if(!0===this.editorData.debug&&o&&o.length>=this.editorData.cols-1){const o=t+(this.editorData.cols-1)*this.CHAR_WIDTH,r=n+i*this.CHAR_HEIGHT;e.fillStyle="#335533",e.fillText("‚§∂",o,r)}}this.drawEditorCursorAndStatus(e,t,n),this.textTexture&&(this.textTexture.needsUpdate=!0)},drawEditorCursorAndStatus:function(e,t,n){if(!this.editorMode||!this.editorData)return;let o=-1,i=-1;if("number"==typeof this.editorData.cursorX&&"number"==typeof this.editorData.cursorY?(o=this.editorData.cursorX,i=this.editorData.cursorY,console.log("[EDITOR-CURSOR] Using cursor position from cursorX/cursorY:",i,o)):"number"==typeof this.editorData.cursorCol&&"number"==typeof this.editorData.cursorLine?(o=this.editorData.cursorCol,i=this.editorData.cursorLine,console.log("[EDITOR-CURSOR] Using fallback cursor position from cursorCol/cursorLine:",i,o)):"number"==typeof this.editorData.visibleCursorCol&&"number"==typeof this.editorData.visibleCursorLine&&(o=this.editorData.visibleCursorCol,i=this.editorData.visibleCursorLine,console.log("[EDITOR-CURSOR] Using final fallback cursor position from visibleCursor:",i,o)),!this.editorData.hideCursor&&o>=0&&i>=0&&i<CFG.TEXT_ROWS-1){e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];const r=t+o*this.CHAR_WIDTH,s=n+i*this.CHAR_HEIGHT;if(e.fillRect(r,s,this.CHAR_WIDTH,this.CHAR_HEIGHT),i<this.editorData.lines.length){const t=this.editorData.lines[i];if(t&&o<t.length){const n=t[o];e.fillStyle="#000000",e.fillText(n,r,s)}}console.log("[EDITOR-CURSOR] Drew cursor at screen position:",i,o)}if(this.editorData.statusText){const o=n+(CFG.TEXT_ROWS-1)*this.CHAR_HEIGHT;e.fillStyle=CFG.BRIGHTNESS_LEVELS[15];const i=o-2,r=this.CHAR_HEIGHT-2;e.fillRect(t,i,CFG.TEXT_COLS*this.CHAR_WIDTH,r),e.fillStyle="#000000";const s=this.editorData.statusText;for(let n=0;n<Math.min(s.length,CFG.TEXT_COLS);n++){const i=s[n],r=t+n*this.CHAR_WIDTH;e.fillText(i,r,o)}e.fillStyle=CFG.BRIGHTNESS_LEVELS[15],console.log("[EDITOR-STATUS] Drew status line (Telnet-style):",this.editorData.statusText)}},handleTelnetMessage:function(e){if("start"===e.content)this.telnetMode=!0,this.telnetServerEcho=!1,console.log("[TELNET-MODE] Telnet mode activated, server:",e.params?.serverName),this.telnetServerName=e.params?.serverName||"Unknown Server",this.inputEnabled=!0,this.runMode=!1,this.lines=[],this.inverseLines=[],this.lines.push(`Connected to ${this.telnetServerName}`),this.inverseLines.push([]),this.lines.push("Press Ctrl+X or ESC to exit telnet session"),this.inverseLines.push([]),this.lines.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"),this.inverseLines.push([]),window.lastTelnetMessage&&(window.lastTelnetMessage={hash:"",time:0});else if("end"===e.content)console.log("[TELNET-MODE] Telnet mode deactivated"),this.telnetMode=!1,this.telnetServerEcho=!1,this.telnetEchoBuffer=[],this.telnetServerName="",window.lastTelnetMessage&&(window.lastTelnetMessage={hash:"",time:0});else if("echo_state"===e.content){if(e.params){this.telnetServerEcho=e.params.serverEcho||!1;const t=e.params.localEcho||!1;console.log(`[TELNET-ECHO] Echo state changed: serverEcho=${this.telnetServerEcho}, localEcho=${t}`),this.telnetEchoBuffer=[]}}else if(this.telnetMode&&e.content)return this.processTerminalData(e.content),void this.drawTerminal();this.drawTerminal()},processTelnetData:function(e){},processTerminalData:function(e){if(e)if(this.backspaceThrottle||(this.backspaceThrottle={lastBackspace:0,throttleMs:50}),255!==e.charCodeAt(0)){for(var t=0;t<e.length;){const n=e[t],o=n.charCodeAt(0);if(255!==o)if(o<32&&13!==o&&10!==o&&9!==o&&27!==o&&8!==o&&7!==o)t++;else{if(""===n&&t+1<e.length&&"["===e[t+1]){let n=t+2;for(;n<e.length&&!/[A-Za-z]/.test(e[n]);)n++;if(n<e.length){const o=e.substring(t,n+1);this.processANSISequence(o),t=n+1;continue}}if("\r"===n)this.cursorX=0;else if("\n"===n)this.cursorY++,this.cursorX=0,this.cursorY=this.ensureLine(this.cursorY),this.validateCursor();else if("\b"===n){const e=Date.now();this.lastBackspaceTime||(this.lastBackspaceTime=0),e-this.lastBackspaceTime>50&&(this.cursorX>0&&(this.cursorX--,this.cursorY=this.ensureLine(this.cursorY),this.cursorY<this.lines.length&&this.lines[this.cursorY].length>this.cursorX&&(this.lines[this.cursorY]=this.lines[this.cursorY].substring(0,this.cursorX)+this.lines[this.cursorY].substring(this.cursorX+1),this.inverseLines[this.cursorY]&&this.inverseLines[this.cursorY].length>this.cursorX&&this.inverseLines[this.cursorY].splice(this.cursorX,1))),this.lastBackspaceTime=e)}else""===n?window.RetroSound&&"function"==typeof window.RetroSound.playBeep&&window.RetroSound.playBeep():o>=32&&(this.cursorY=this.ensureLine(this.cursorY),this.setCharAt(this.cursorY,this.cursorX,n),this.cursorX++,this.validateCursor());t++}else{if(t+2<e.length){const n=e.charCodeAt(t+1);if(n>=251&&n<=254){t+=3;continue}}t+=2}}this.drawTerminal()}else this.processTelnetIAC(e)},processTelnetIAC:function(e){if(e.length>=3){e.charCodeAt(0);var t=e.charCodeAt(1),n=e.charCodeAt(2);31===n?253===t&&(this.sendTelnetResponse([255,251,31]),this.sendWindowSize()):1===n?251===t?(console.log("[TELNET-ECHO] Server WILL ECHO - disabling local echo"),this.sendTelnetResponse([255,253,1]),this.telnetServerEcho=!0):252===t?(console.log("[TELNET-ECHO] Server WONT ECHO - enabling local echo"),this.sendTelnetResponse([255,254,1]),this.telnetServerEcho=!1):253===t&&(console.log("[TELNET-ECHO] Server asks DO ECHO - we refuse"),this.sendTelnetResponse([255,252,1])):24===n&&253===t&&this.sendTelnetResponse([255,251,24])}},sendTelnetResponse:function(e){for(var t="",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);const o={type:1,content:t,sessionId:window.sessionId};window.sendMessageWithSessionID&&window.sendMessageWithSessionID(o)},sendWindowSize:function(){var e=CFG.TEXT_COLS,t=CFG.TEXT_ROWS,n=[255,250,31,Math.floor(e/256),e%256,Math.floor(t/256),t%256,255,240];this.sendTelnetResponse(n)},processANSISequence:function(e){if(e.includes("?25h"))return void(this.forcedHideCursor=!1);if(e.includes("?25l"))return void(this.forcedHideCursor=!0);const t=e.match(/\x1b\[([0-9;]*)m/);if(t){const e=t[1]?t[1].split(";").map(e=>parseInt(e)||0):[0];for(const t of e)switch(t){case 0:case 27:this.inverseMode=!1;break;case 7:this.inverseMode=!0}return}const n=e.match(/\x1b\[([0-9;]*)([A-Za-z])/);if(!n)return;const o=n[1]?n[1].split(";").map(e=>parseInt(e)||0):[0];switch(n[2]){case"H":case"f":o.length>=2?(this.cursorY=Math.max(0,(o[0]||1)-1),this.cursorX=Math.max(0,(o[1]||1)-1)):(this.cursorY=0,this.cursorX=0),this.telnetMode&&(this.cursorY>=CFG.TEXT_ROWS&&(this.cursorY=CFG.TEXT_ROWS-1),this.cursorX>=CFG.TEXT_COLS&&(this.cursorX=CFG.TEXT_COLS-1)),this.cursorY=this.ensureLine(this.cursorY);break;case"J":const e=o[0]||0;2===e?(this.lines=[],this.inverseLines=[],this.cursorY=0,this.cursorX=0):0===e&&this.cursorY<this.lines.length&&(this.lines[this.cursorY]=this.lines[this.cursorY].substring(0,this.cursorX),this.lines.splice(this.cursorY+1),this.inverseLines.splice(this.cursorY+1));break;case"K":const t=o[0]||0;2===t?this.cursorY<this.lines.length&&(this.lines[this.cursorY]="",this.inverseLines[this.cursorY]=[]):0===t&&this.cursorY<this.lines.length&&(this.lines[this.cursorY]=this.lines[this.cursorY].substring(0,this.cursorX));break;case"A":this.cursorY=Math.max(0,this.cursorY-(o[0]||1));break;case"B":this.cursorY=this.cursorY+(o[0]||1),this.cursorY=this.ensureLine(this.cursorY);break;case"C":this.cursorX=this.cursorX+(o[0]||1);break;case"D":this.cursorX=Math.max(0,this.cursorX-(o[0]||1))}},validateCursor:function(){const e=CFG.TEXT_ROWS-1;this.cursorX>=CFG.TEXT_COLS&&(this.cursorX=0,this.cursorY++,this.cursorY>=e&&(this.cursorY=e-1,this.lines.shift(),this.inverseLines.shift(),this.lines.push(""),this.inverseLines.push([]))),this.cursorY>=e&&(this.cursorY=e-1),this.cursorX=Math.max(0,this.cursorX),this.cursorY=Math.max(0,this.cursorY)},ensureLine:function(e){const t=CFG.TEXT_ROWS-1;for(;this.lines.length<=e;)this.lines.push(""),this.inverseLines.push([]);for(;this.lines.length>t;)this.debugMode,this.lines.shift(),this.inverseLines.shift(),this.cursorY>0&&this.cursorY--,e>0&&e--,this.debugMode;return e},setCharAt:function(e,t,n){e=this.ensureLine(e);let o=this.lines[e];for(;o.length<=t;)o+=" ";o=o.substring(0,t)+n+o.substring(t+1),this.lines[e]=o},handleEditorKeyDown:function(e){if(!this.editorMode||!this.editorData)return void console.warn("[EDITOR-INPUT] handleEditorKeyDown called without editorMode or editorData");if(this.editorData.readOnly){const t=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown"],n=e.ctrlKey&&"c"===e.key.toLowerCase(),o=e.ctrlKey&&"x"===e.key.toLowerCase(),i="Escape"===e.key;if(t.includes(e.key));else if(!(n||o||i))return e.preventDefault(),void console.log("[EDITOR-INPUT] Text input blocked in read-only mode:",e.key)}let t=!0;if(this.editorData.readOnly){const n=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","PageUp","PageDown","Escape"],o=e.ctrlKey&&"c"===e.key.toLowerCase(),i=e.ctrlKey&&"x"===e.key.toLowerCase();(n.includes(e.key)||o||i)&&(t=!1)}t&&(!e.ctrlKey||e.ctrlKey&&!["c","v"].includes(e.key.toLowerCase()))&&e.preventDefault();let n="key_input",o={};const i={Escape:"Escape",ArrowUp:"ArrowUp",ArrowDown:"ArrowDown",ArrowLeft:"ArrowLeft",ArrowRight:"ArrowRight",Home:"Home",End:"End",PageUp:"PageUp",PageDown:"PageDown",Backspace:"Backspace",Delete:"Delete",Enter:"Enter",Tab:"Tab"};e.ctrlKey&&"s"===e.key.toLowerCase()?o={key:"CTRL+S"}:e.ctrlKey&&"x"===e.key.toLowerCase()?o={key:"CTRL+X"}:e.ctrlKey&&"c"===e.key.toLowerCase()?o={key:"CTRL+C"}:i[e.key]?o={key:i[e.key]}:1===e.key.length?o={key:"char",char:e.key}:n=null,n&&"function"==typeof window.sendEditorCommand?(console.log("[EDITOR-INPUT] Sending command to backend:",n,o),window.sendEditorCommand(n,o)):n?console.error("[EDITOR-INPUT] sendEditorCommand function not available"):console.log("[EDITOR-INPUT] No command mapped for key:",e.key)},startFilenameInput:function(e){console.log("[EDITOR-DEBUG] Starting filename input mode"),setTimeout(()=>{this.filenameInputMode=!0,this.filenameInput="";const t=e.params&&e.params.prompt?e.params.prompt:"Save as: ";this.filenamePrompt=t,this.editorStatus=t,this.editorMode&&"function"==typeof this.drawEditor?this.drawEditor():this.drawTerminal(),console.log("[EDITOR-DEBUG] Filename input mode started with prompt:",t)},50)},stopFilenameInput:function(){console.log("[EDITOR-DEBUG] Stopping filename input mode"),this.filenameInputMode=!1,this.filenameInput="",this.filenamePrompt="",this.editorStatus=""},initiateChatMode:function(){if(window.chatWs&&window.chatWs.readyState===WebSocket.OPEN)return;const e=window.sessionId||window.sessionStorage&&window.sessionStorage.getItem("sessionId");if(!e)return this.lines.push("Error: No valid session found for chat."),void this.drawTerminal();let t=null;if(window.authManager&&window.authManager.token)t=window.authManager.token;else try{t=localStorage.getItem("tinyos_token")}catch(e){console.warn("[CHAT] Could not access localStorage for token")}if(!t)return this.lines.push("Error: No valid authentication token found for chat."),void this.drawTerminal();const n=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/chat?token=${encodeURIComponent(t)}&session=${encodeURIComponent(e)}`,o=e;try{window.chatWs=new WebSocket(n),window.chatWs.onopen=function(){const e={type:"auth",sessionId:o};window.chatWs.send(JSON.stringify(e))},window.chatWs.onmessage=function(e){try{e.data.trim().split("\n").filter(e=>""!==e.trim()).forEach(function(e){try{const t=JSON.parse(e);if(t.content){let e="";"ai"===t.role?e="MCP: ":"system"===t.role&&(e="System: ");const n=window.RetroConsole.wrapText(e+t.content,CFG.TEXT_COLS);window.RetroConsole.lines.push(...n)}if(2===t.type?window.RetroSound&&"function"==typeof window.RetroSound.playBeep&&window.RetroSound.playBeep():3===t.type&&window.RetroSound&&"function"==typeof window.RetroSound.speakText&&window.RetroSound.speakText(t.content),t.error){const e=window.RetroConsole.wrapText("Error: "+t.error,CFG.TEXT_COLS);window.RetroConsole.lines.push(...e)}}catch(e){}}),window.RetroConsole.drawTerminal()}catch(e){window.RetroConsole.lines.push("Error processing chat response."),window.RetroConsole.drawTerminal()}},window.chatWs.onclose=function(e){window.RetroConsole.inputEnabled=!0,window.RetroConsole.lines.push(""),window.RetroConsole.lines.push("Chat terminated."),window.RetroConsole.drawTerminal(),window.chatWs=null},window.chatWs.onerror=function(e){window.RetroConsole.inputEnabled=!0,window.RetroConsole.lines.push("Error in chat connection."),window.RetroConsole.drawTerminal(),window.chatWs=null},window.chatWs.addEventListener("ping",function(e){}),window.chatWs.addEventListener("pong",function(e){}),window.chatWs.addEventListener("open",function(e){}),window.chatWs.addEventListener("close",function(e){window.chatKeepAliveInterval&&(clearInterval(window.chatKeepAliveInterval),window.chatKeepAliveInterval=null)}),window.chatKeepAliveInterval=setInterval(function(){if(window.chatWs&&window.chatWs.readyState===WebSocket.OPEN)try{window.chatWs.send(JSON.stringify({type:"keepalive"}))}catch(e){}},3e4)}catch(e){this.lines.push("Error opening chat connection."),this.drawTerminal()}},initScreenBuffer:function(){if(!this.screenBuffer){this.screenBuffer=[];for(let e=0;e<CFG.TEXT_ROWS;e++){this.screenBuffer[e]=[];for(let t=0;t<CFG.TEXT_COLS;t++)this.screenBuffer[e][t]={char:" ",inverse:!1}}}},setTextAtPosition:function(e,t,n,o=!1){if(this.initScreenBuffer(),!(t<0||t>=CFG.TEXT_ROWS))for(let i=0;i<n.length&&e+i<CFG.TEXT_COLS;i++)e+i>=0&&(this.screenBuffer[t][e+i]={char:n[i],inverse:o})},handleBitmapMessage:function(e){console.log("[RetroConsole-BITMAP] Processing bitmap message:",e),console.log("[RetroConsole-BITMAP] BitmapData length:",e.bitmapData?e.bitmapData.length:"undefined"),console.log("[RetroConsole-BITMAP] Position:",e.bitmapX,e.bitmapY),console.log("[RetroConsole-BITMAP] Scale:",e.bitmapScale),console.log("[RetroConsole-BITMAP] ID:",e.bitmapID);const t=new Image;t.onload=()=>{console.log("[RetroConsole-BITMAP] Image loaded successfully, dimensions:",t.width,"x",t.height);const n=document.createElement("canvas"),o=n.getContext("2d");n.width=t.width,n.height=t.height,o.drawImage(t,0,0),console.log("[RetroConsole-BITMAP] Canvas created, size:",n.width,"x",n.height);const i=o.getImageData(0,0,n.width,n.height),r=i.data,s=window.CONFIG&&window.CONFIG.BRIGHTNESS_LEVELS?window.CONFIG.BRIGHTNESS_LEVELS:["#000000","#001500","#002500","#003500","#004500","#005500","#006000","#007000","#008000","#009000","#00A000","#00B000","#00C000","#00D000","#00E000","#5FFF5F"];for(let e=0;e<r.length;e+=4){const t=(r[e]+r[e+1]+r[e+2])/3,n=s[Math.min(15,Math.floor(t/16))],o=parseInt(n.slice(1,3),16),i=parseInt(n.slice(3,5),16),a=parseInt(n.slice(5,7),16);r[e]=o,r[e+1]=i,r[e+2]=a}o.putImageData(i,0,0),console.log("[RetroConsole-BITMAP] Applied retro quantization effect with green mapping");const a=e.bitmapScale||1;if(1!==a){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=n.width*a,e.height=n.height*a,t.drawImage(n,0,0,e.width,e.height),n.width=e.width,n.height=e.height,o.drawImage(e,0,0)}const l=e.bitmapRotate||0;if(0!==l){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=n.width,e.height=n.height,t.translate(n.width/2,n.height/2),t.rotate(l*Math.PI/180),t.drawImage(n,-n.width/2,-n.height/2),n.width=e.width,n.height=e.height,o.clearRect(0,0,n.width,n.height),o.drawImage(e,0,0)}const c=e.bitmapX||0,d=e.bitmapY||0;console.log("[RetroConsole-BITMAP] Drawing bitmap at position:",c,d);const u=window.RetroGraphics?.persistent2DContext||window.persistent2DContext,h=window.RetroGraphics?.persistent2DCanvas||window.persistent2DCanvas;if(window.RetroGraphics&&u&&h)try{u.drawImage(n,c,d),window.RetroGraphics._graphics2DDirty=!0}catch(e){console.error("[RetroConsole-BITMAP] Error drawing bitmap to persistent 2D graphics:",e)}},t.onerror=n=>{console.error("[RetroConsole-BITMAP] Failed to load bitmap image:",n),console.error("[RetroConsole-BITMAP] Image src:",t.src),console.error("[RetroConsole-BITMAP] BitmapData preview:",e.bitmapData?e.bitmapData.substring(0,100)+"...":"undefined")},e.bitmapData?(console.log("[RetroConsole-BITMAP] Setting image src with base64 data"),t.src="data:image/png;base64,"+e.bitmapData):console.error("[RetroConsole-BITMAP] No bitmapData provided in response")},refreshTokenForSession:async function(e){if(console.log("[RetroConsole-TOKEN] Refreshing token for session:",e),window.authManager||window.globalAuthManager){const t=window.authManager||window.globalAuthManager;try{console.log("[RetroConsole-TOKEN] Requesting token for session:",e);const n=await fetch(`${window.location.origin}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({sessionId:e})}),o=await n.json();o.success&&o.token?(t.setStoredToken(o.token),t.setStoredSessionId(o.sessionId),console.log("[RetroConsole-TOKEN] Token successfully refreshed"),console.log("[RetroConsole-TOKEN] New token:",o.token.substring(0,20)+"...")):console.error("[RetroConsole-TOKEN] Failed to refresh token:",o.message)}catch(e){console.error("[RetroConsole-TOKEN] Error refreshing token:",e)}}else console.warn("[RetroConsole-TOKEN] Auth manager not available for token refresh")}});let graphicsInitialized=!1,globalAuthManager=null;function initializeNonGraphics(){const e=setInterval(()=>{window.RetroConsole&&"function"==typeof window.RetroConsole.handleBackendMessage&&"function"==typeof window.RetroConsole.drawTerminal&&"function"==typeof window.RetroConsole.updateCharMetrics&&(clearInterval(e),window.RetroSound&&(window.RetroSound.initAudio(),window.RetroSound.initSpeech(),"function"!=typeof window.RetroSound.playSound&&(window.RetroSound.playSound=function(e,t){try{window.RetroSound.audioContext||(window.RetroSound.audioContext=new(window.AudioContext||window.webkitAudioContext));const n=window.RetroSound.audioContext;"suspended"===n.state&&n.resume();const o=n.createOscillator(),i=n.createGain();o.type="sine",o.frequency.setValueAtTime(e||440,n.currentTime),i.gain.setValueAtTime(.2,n.currentTime),o.connect(i),i.connect(n.destination),o.start(),o.stop(n.currentTime+(t?t/1e3:.2))}catch(e){}})),(async()=>{await setupWebSocket()})(),window.retroGraphicsFullyInitialized?initializeGraphics():document.addEventListener("retrographicsready",initializeGraphics,{once:!0}))},100)}function initializeGraphics(){if(!graphicsInitialized&&(graphicsInitialized=!0,window.RetroGraphics&&"function"==typeof window.RetroGraphics.initGraphicsPipeline&&"function"==typeof window.RetroGraphics.animateCRT))try{window.RetroConsole&&"function"==typeof window.RetroConsole.updateCharMetrics&&("function"==typeof window.RetroConsole.initTextCanvas&&window.RetroConsole.initTextCanvas(),window.RetroConsole.updateCharMetrics());const e=window.RetroConsole?window.RetroConsole.textCanvas:null,t=window.RetroConsole?window.RetroConsole.textTexture:null;e&&t?window.RetroGraphics.initGraphicsPipeline(e,t):window.RetroGraphics.initGraphicsPipeline(),"function"==typeof window.RetroGraphics.initDynamicViewportForGraphics&&window.RetroGraphics.initDynamicViewportForGraphics(),window.RetroGraphics.animateCRT(),setupInputHandling(),window.RetroConsole&&(window.RetroConsole.inputEnabled=!0,"function"==typeof window.RetroConsole.drawTerminal&&window.RetroConsole.drawTerminal()),setTimeout(()=>{window.RetroGraphics&&"function"==typeof window.RetroGraphics.debugVectorRendering&&(window.RetroGraphics.debugVectorRendering(),window.vectorDebugInterval=setInterval(()=>{if(window.RetroGraphics&&window.RetroGraphics.getVectorSceneInfo){const e=window.RetroGraphics.getVectorSceneInfo();e.initialized&&0!==e.children||window.RetroGraphics.resetAndRebuildVectorScene&&window.RetroGraphics.resetAndRebuildVectorScene()||window.RetroGraphics.debugVectorRendering()}},3e3)),window.addEventListener("focus",()=>{window.RetroGraphics&&("function"==typeof window.RetroGraphics.resetAndRebuildVectorScene&&window.RetroGraphics.resetAndRebuildVectorScene()||"function"==typeof window.RetroGraphics.debugVectorRendering&&window.RetroGraphics.debugVectorRendering())})},2e3)}catch(e){window.RetroConsole&&Array.isArray(window.RetroConsole.lines)&&(window.RetroConsole.lines.push("Graphics initialization error!"),e.message&&window.RetroConsole.lines.push(e.message.substring(0,CFG.TEXT_COLS-2)),"function"==typeof window.RetroConsole.drawTerminal&&window.RetroConsole.drawTerminal())}}async function setupWebSocket(){window.ws&&window.ws.readyState!==WebSocket.CLOSED&&(window.ws.close(),window.ws=null),globalAuthManager||(globalAuthManager=new AuthManager,await globalAuthManager.initialize());const e=await globalAuthManager.getWebSocketUrl();try{const t=new WebSocket(e);window.ws=t,t.onopen=()=>{const e={type:7,content:"",sessionId:globalAuthManager.sessionId||getSessionID()||""};t.send(JSON.stringify(e)),setTimeout(()=>{"function"==typeof window.sendTerminalConfig&&sendTerminalConfig()},300),window.RetroConsole&&(window.RetroConsole.inputEnabled=!0,Array.isArray(window.RetroConsole.lines)?window.RetroConsole.lines.push("Dialing mainframe..."):window.RetroConsole.lines=["Dialing mainframe..."],"function"==typeof window.RetroConsole.drawTerminal&&window.RetroConsole.drawTerminal(),"function"==typeof window.RetroConsole.startCursorBlink&&window.RetroConsole.startCursorBlink())},t.onmessage=function(e){window.RetroConsole&&"function"==typeof window.RetroConsole.handleBackendMessage?window.RetroConsole.handleBackendMessage(e):console.error("RetroConsole.handleBackendMessage not available")},t.onclose=e=>{console.log("[FRONTEND-DEBUG] WebSocket connection closed:",{timestamp:(new Date).toISOString(),code:e.code,reason:e.reason,wasClean:e.wasClean}),window.sessionRecoveryInProgress||(1006===e.code||1011===e.code?attemptSessionRecovery():RetroConsole.lines.push("Terminal connection lost, please reload."))},t.onerror=e=>{console.log("[FRONTEND-DEBUG] WebSocket error occurred:",{timestamp:(new Date).toISOString(),error:e}),window.sessionRecoveryInProgress||attemptSessionRecovery()},t.addEventListener("ping",e=>{}),t.addEventListener("pong",e=>{});const n=setInterval(()=>{if(t.readyState===WebSocket.OPEN)try{t.send(JSON.stringify({type:"keepalive"}))}catch(e){}},3e4);t.addEventListener("close",()=>{clearInterval(n)}),window.backendSocket=t}catch(e){window.RetroConsole&&window.RetroConsole.lines&&window.RetroConsole.lines.push("Connection problems occurred.")}}function initSecurity(){return{csrfToken:"dummy-csrf-token",sessionToken:"dummy-session-token"}}function setupInputHandling(){window.inputHandlingSetup||(window.inputHandlingSetup=!0,window.addEventListener("keydown",function(e){if(!window.RetroConsole||!graphicsInitialized)return;if(window.RetroConsole.pagerMode)return void handlePagerKeyDown(e);if(window.RetroConsole&&window.RetroConsole.telnetMode)return e.preventDefault(),e.stopPropagation(),void("function"==typeof handleTelnetKeyDown?handleTelnetKeyDown(e):console.error("handleTelnetKeyDown function not available"));if(window.RetroConsole&&window.RetroConsole.editorMode)return void("function"==typeof window.RetroConsole.handleEditorKeyDown&&(window.RetroConsole.handleEditorKeyDown(e),"function"==typeof window.RetroConsole.drawEditor&&window.RetroConsole.drawEditor()));if(e.ctrlKey&&"c"===e.key.toLowerCase()){e.preventDefault();const t={type:1,content:"__BREAK__"};return!window.RetroConsole.runMode&&window.RetroConsole.inputEnabled&&window.RetroConsole.lines.push(window.RetroConsole.promptSymbol+"^C"),sendMessageWithSessionID(t),window.RetroConsole.input="",window.RetroConsole.cursorPos=0,void window.RetroConsole.drawTerminal()}if(shouldSendKeyEvent(e.key)&&sendKeyEvent(16,e.key),!window.RetroConsole.inputEnabled)return;["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","Backspace","Delete","PageUp","PageDown"].includes(e.key)&&e.preventDefault();window.ws;switch(e.key){case"Enter":if(window.RetroConsole&&window.RetroConsole.telnetMode)return;if(window.RetroConsole.runMode)return;if(window.chatWs&&window.chatWs.readyState===WebSocket.OPEN){const e={type:"text",content:window.RetroConsole.input,cols:CFG.TEXT_COLS,rows:CFG.TEXT_ROWS},t="You: "+window.RetroConsole.input,n=window.RetroConsole.wrapText(t,CFG.TEXT_COLS);window.RetroConsole.lines.push(...n);for(let e=0;e<n.length;e++)window.RetroConsole.inverseLines.push(Array(n[e].length).fill(!1));"function"==typeof window.RetroConsole.checkAndScroll&&window.RetroConsole.checkAndScroll(),window.chatWs.send(JSON.stringify(e)),window.RetroConsole.input="",window.RetroConsole.cursorPos=0,window.RetroConsole.drawTerminal()}else{if(window.RetroConsole&&2===window.RetroConsole.inputMode){sendMessageWithSessionID({type:1,content:window.RetroConsole.input})&&(window.RetroConsole.input="",window.RetroConsole.cursorPos=0,window.RetroConsole.drawTerminal());break}const e={type:1,content:window.RetroConsole.input};let t=window.RetroConsole.input;window.RetroConsole.passwordMode&&(t="*".repeat(window.RetroConsole.input.length));const n=window.RetroConsole.promptSymbol+t,o=CFG.TEXT_COLS;if(n.length<=o)window.RetroConsole.lines.push(n),window.RetroConsole.inverseLines.push(Array(n.length).fill(!1));else{let e=n;for(;e.length>0;){const t=e.substring(0,o);window.RetroConsole.lines.push(t),window.RetroConsole.inverseLines.push(Array(t.length).fill(!1)),e=e.substring(o)}}"function"==typeof window.RetroConsole.checkAndScroll&&window.RetroConsole.checkAndScroll(),sendMessageWithSessionID(e),window.RetroConsole.input="",window.RetroConsole.cursorPos=0,window.RetroConsole.drawTerminal()}break;case"Backspace":if(window.RetroConsole&&window.RetroConsole.telnetMode)return;if(window.RetroConsole.runMode)return;window.RetroConsole.cursorPos>0&&(window.RetroConsole.input=window.RetroConsole.input.substring(0,window.RetroConsole.cursorPos-1)+window.RetroConsole.input.substring(window.RetroConsole.cursorPos),window.RetroConsole.cursorPos--,window.RetroConsole.drawTerminal());break;case"ArrowLeft":if(window.RetroConsole.runMode)return;window.RetroConsole.cursorPos>0&&(window.RetroConsole.cursorPos--,window.RetroConsole.drawTerminal());break;case"ArrowRight":if(window.RetroConsole.runMode)return;window.RetroConsole.cursorPos<window.RetroConsole.input.length&&(window.RetroConsole.cursorPos++,window.RetroConsole.drawTerminal());break;default:if(1===e.key.length&&!e.ctrlKey&&!e.altKey&&!e.metaKey){e.preventDefault();const t=e.key;window.RetroConsole.input=window.RetroConsole.input.substring(0,window.RetroConsole.cursorPos)+t+window.RetroConsole.input.substring(window.RetroConsole.cursorPos),window.RetroConsole.cursorPos++,window.RetroConsole.drawTerminal()}}}),window.addEventListener("keyup",function(e){window.RetroConsole&&graphicsInitialized&&(window.RetroConsole&&window.RetroConsole.telnetMode||window.RetroConsole&&window.RetroConsole.editorMode||shouldSendKeyEvent(e.key)&&sendKeyEvent(17,e.key))}))}function handleFilenameInputKeyDown(e){e.preventDefault();const t=e.key;if(e.ctrlKey)switch(t.toLowerCase()){case"s":case"enter":return void sendEditorCommand("filename_submit",window.RetroConsole.filenameInput||"")}switch(t){case"Enter":return void sendEditorCommand("filename_submit",window.RetroConsole.filenameInput||"");case"Escape":return void sendEditorCommand("filename_cancel","");case"Backspace":return void(window.RetroConsole.filenameInput.length>0&&(window.RetroConsole.filenameInput=window.RetroConsole.filenameInput.slice(0,-1),updateFilenameDisplay()));default:return void(1!==t.length||e.ctrlKey||e.altKey||(window.RetroConsole.filenameInput+=t,updateFilenameDisplay()))}}function updateFilenameDisplay(){window.RetroConsole.filenameInputMode&&(window.RetroConsole.editorStatus=window.RetroConsole.filenamePrompt+window.RetroConsole.filenameInput,window.RetroConsole.editorMode&&"function"==typeof window.RetroConsole.drawEditor?window.RetroConsole.drawEditor():window.RetroConsole.drawTerminal())}function sendEditorCommand(e,t){if(!window.ws||window.ws.readyState!==WebSocket.OPEN)return;const n={type:20,editorCommand:e,editorData:"object"==typeof t?JSON.stringify(t):t||"",sessionId:window.sessionId};try{window.ws.send(JSON.stringify(n))}catch(e){}}function safeRetroConsoleAccess(e){return window.RetroConsole?e():(setTimeout(()=>safeRetroConsoleAccess(e),100),null)}function getSessionID(){return(window.sessionStorage?window.sessionStorage.getItem("sessionId"):window.sessionId)||""}function sendMessageWithSessionID(e){const t=window.ws;if(t&&t.readyState===WebSocket.OPEN){e.sessionId||(e.sessionId=getSessionID());const n=JSON.stringify(e);if(console.log("[FRONTEND-DEBUG] Sending WebSocket message:",{timestamp:(new Date).toISOString(),messageType:e.type,contentPreview:e.content?String(e.content).substring(0,50):"null",sessionId:e.sessionId,telnetMode:!!window.RetroConsole&&window.RetroConsole.telnetMode}),window.RetroConsole&&window.RetroConsole.telnetMode&&1===e.type){const t=Date.now(),n=e.content+e.sessionId;if(window.lastTelnetMessage||(window.lastTelnetMessage={hash:"",time:0}),window.lastTelnetMessage.hash===n&&t-window.lastTelnetMessage.time<10)return console.log("[TELNET-DUPE] Prevented duplicate message:",e.content),!1;window.lastTelnetMessage={hash:n,time:t}}return t.send(n),!0}return console.error("[FRONTEND-DEBUG] WebSocket not available or not open for sending message. ReadyState:",t?t.readyState:"null"),!1}function sendTerminalConfig(){safeRetroConsoleAccess(()=>{if(!window.CRT_CONFIG)return;sendMessageWithSessionID({type:8,width:window.CRT_CONFIG.TEXT_COLS,height:window.CRT_CONFIG.TEXT_ROWS-1,sessionID:getSessionID()})})}function requestGuestToken(){if(!guestTokenRequested){guestTokenRequested=!0;sendMessageWithSessionID({content:"guest-token",type:7})}}function saveToken(e){jwtToken=e;try{localStorage.setItem("jwtToken",e)}catch(e){}}function loadToken(){jwtToken=localStorage.getItem("jwtToken")}function deleteToken(){jwtToken=null,localStorage.removeItem("jwtToken")}function attemptSessionRecovery(){window.sessionRecoveryInProgress||(window.sessionRecoveryInProgress=!0,setTimeout(()=>{try{window.ws&&window.ws.readyState===WebSocket.OPEN&&window.ws.close(),window.sessionStorage&&window.sessionStorage.removeItem("sessionId"),window.sessionId=null,globalAuthManager=null,(async()=>{await setupWebSocket()})(),setTimeout(()=>{window.sessionRecoveryInProgress=!1},2e3)}catch(e){window.sessionRecoveryInProgress=!1,window.RetroConsole&&window.RetroConsole.lines&&(window.RetroConsole.lines.push("Session expired. Please reload the page."),"function"==typeof window.RetroConsole.drawTerminal&&window.RetroConsole.drawTerminal())}},1e3))}function shouldSendKeyEvent(e){return"Escape"===e||"ArrowUp"===e||"ArrowDown"===e||"ArrowLeft"===e||"ArrowRight"===e||"Home"===e||"End"===e||"PageUp"===e||"PageDown"===e||1===e.length&&/[a-zA-Z0-9 ]/.test(e)}function sendKeyEvent(e,t){if(!window.ws||window.ws.readyState!==WebSocket.OPEN)return!1;const n={type:e,key:t};try{return window.ws.send(JSON.stringify(n)),!0}catch(e){return!1}}function handlePagerKeyDown(e){e.preventDefault();const t=e.key.toLowerCase();if("m"===t||"q"===t||"enter"===t){let e=t;"enter"===t&&(e="m");sendMessageWithSessionID({type:1,content:e})}}function handleTelnetKeyDown(e){try{if(window.telnetEscapeState||(window.telnetEscapeState={expectingCommand:!1,commandBuffer:"",lastTilde:!1}),"~"===e.key&&!window.telnetEscapeState.expectingCommand)return e.preventDefault(),void(window.telnetEscapeState.lastTilde=!0);if(window.telnetEscapeState.lastTilde){if(window.telnetEscapeState.lastTilde=!1,"."===e.key)return e.preventDefault(),window.telnetEscapeState.expectingCommand=!0,window.telnetEscapeState.commandBuffer="",void(window.RetroConsole&&(window.RetroConsole.lines.push("~. (Local TinyOS command - type 'help' or 'exit' to return to telnet)"),window.RetroConsole.inverseLines.push([]),window.RetroConsole.lines.push("TinyOS> "),window.RetroConsole.inverseLines.push([]),window.RetroConsole.drawTerminal()));sendMessageWithSessionID({type:1,content:"~",sessionId:window.sessionId})}if(window.telnetEscapeState.expectingCommand){if(e.preventDefault(),"Enter"===e.key){const e=window.telnetEscapeState.commandBuffer.trim();if(window.telnetEscapeState.expectingCommand=!1,window.telnetEscapeState.commandBuffer="","exit"===e||"return"===e)return void(window.RetroConsole&&(window.RetroConsole.lines.push("Returning to telnet session..."),window.RetroConsole.inverseLines.push([]),window.RetroConsole.drawTerminal()));if("help"===e)return window.RetroConsole&&(window.RetroConsole.lines.push("Local TinyOS commands available:"),window.RetroConsole.inverseLines.push([]),window.RetroConsole.lines.push("  debug telnet  - Show telnet session status"),window.RetroConsole.inverseLines.push([]),window.RetroConsole.lines.push("  exit/return  - Return to telnet session"),window.RetroConsole.inverseLines.push([]),window.RetroConsole.lines.push("  help         - Show this help"),window.RetroConsole.inverseLines.push([]),window.RetroConsole.lines.push("TinyOS> "),window.RetroConsole.inverseLines.push([]),window.RetroConsole.drawTerminal()),void(window.telnetEscapeState.expectingCommand=!0);return sendMessageWithSessionID({type:0,content:e,sessionId:window.sessionId,localCommand:!0}),void(window.RetroConsole&&(window.RetroConsole.lines.push("Command sent to TinyOS. Returning to telnet session..."),window.RetroConsole.inverseLines.push([]),window.RetroConsole.drawTerminal()))}if("Backspace"===e.key){if(window.telnetEscapeState.commandBuffer.length>0&&(window.telnetEscapeState.commandBuffer=window.telnetEscapeState.commandBuffer.slice(0,-1),window.RetroConsole&&window.RetroConsole.lines.length>0)){window.RetroConsole.lines[window.RetroConsole.lines.length-1].startsWith("TinyOS> ")&&(window.RetroConsole.lines[window.RetroConsole.lines.length-1]="TinyOS> "+window.telnetEscapeState.commandBuffer,window.RetroConsole.drawTerminal())}return}if("Escape"===e.key)return window.telnetEscapeState.expectingCommand=!1,window.telnetEscapeState.commandBuffer="",void(window.RetroConsole&&(window.RetroConsole.lines.push("Local command cancelled. Returning to telnet session..."),window.RetroConsole.inverseLines.push([]),window.RetroConsole.drawTerminal()));if(1===e.key.length){if(window.telnetEscapeState.commandBuffer+=e.key,window.RetroConsole&&window.RetroConsole.lines.length>0){window.RetroConsole.lines[window.RetroConsole.lines.length-1].startsWith("TinyOS> ")&&(window.RetroConsole.lines[window.RetroConsole.lines.length-1]="TinyOS> "+window.telnetEscapeState.commandBuffer,window.RetroConsole.drawTerminal())}return}return}if(e.ctrlKey&&"x"===e.key.toLowerCase()||"Escape"===e.key){let t;e.preventDefault(),e.ctrlKey&&"x"===e.key.toLowerCase()?t="":"Escape"===e.key&&(t="");return void sendMessageWithSessionID({type:1,content:t,sessionId:window.sessionId})}if(e.ctrlKey&&!e.altKey){let t=null;const n=e.key.toLowerCase();if("c"===n?t="":"d"===n?t="":"z"===n?t="":"l"===n?t="\f":"u"===n?(t="",t="\v"):"a"===n?t="":"e"===n?t="":"w"===n?t="":"r"===n?t="":"n"===n?t="":"p"===n?t="":"f"===n?t="":"b"===n?t="":"h"===n?t="\b":"t"===n?t="":"v"===n?t="":"y"===n&&(t=""),null!==t){e.preventDefault();return void sendMessageWithSessionID({type:1,content:t,sessionId:window.sessionId})}}let t=null;if("Enter"===e.key)t="\r\n";else if("Backspace"===e.key)t="\b";else if("Tab"===e.key)t="\t";else if("Delete"===e.key)t="";else if("ArrowUp"===e.key)t="[A";else if("ArrowDown"===e.key)t="[B";else if("ArrowRight"===e.key)t="[C";else if("ArrowLeft"===e.key)t="[D";else if("Home"===e.key)t="[H";else if("End"===e.key)t="[F";else if("PageUp"===e.key)t="[5~";else if("PageDown"===e.key)t="[6~";else if("Insert"===e.key)t="[2~";else if(e.key.startsWith("F")&&e.key.length<=3){const n=parseInt(e.key.substring(1));if(n>=1&&n<=12){t={1:"OP",2:"OQ",3:"OR",4:"OS",5:"[15~",6:"[17~",7:"[18~",8:"[19~",9:"[20~",10:"[21~",11:"[23~",12:"[24~"}[n]||null}}else 1===e.key.length&&(t=e.key);if(null!==t){e.preventDefault();window.RetroConsole&&!window.RetroConsole.telnetServerEcho&&1===t.length&&t>=" "&&t<="~"&&(window.RetroConsole.processTerminalData(t),window.RetroConsole.drawTerminal());sendMessageWithSessionID({type:1,content:t,sessionId:window.sessionId})}}catch(e){}}!function(){const e=console.warn;console.warn=function(t){"string"==typeof t&&(t.includes("ScriptProcessorNode")||t.includes("createJavaScriptNode"))||e.apply(console,arguments)}}(),window.DynamicViewport&&"function"==typeof window.DynamicViewport.init&&window.DynamicViewport.init(),window.sendEditorCommand=sendEditorCommand,document.addEventListener("DOMContentLoaded",()=>{initializeNonGraphics(),document.addEventListener("retrographicsready",()=>{graphicsInitialized||initializeGraphics()})}),window.getSessionID=getSessionID,window.sendTerminalConfig=sendTerminalConfig;