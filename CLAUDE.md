# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Retroterm is a browser-based retro terminal with a Go backend that emulates a vintage computing experience. It features a TinyBASIC interpreter with AI integration, virtual filesystem, authentication system, and multimedia capabilities including graphics, sound, and chess.

## Development Commands

### Build System
- `npm run build` - Create production build with minified assets and cross-platform binaries
- `npm run build:dev` - Development build without minification
- `npm run build:clean` - Clean build (removes dist/ directory first)
- `npm run serve` - Serve production build on port 8080
- `npm run serve:dev` - Serve development files on port 3000

### Go Backend
- `go run main.go` - Run development server
- `go build -o retroterm main.go` - Build binary
- `go test ./tests/` - Run authentication and security tests
- `go test -v ./tests/ -run TestAuth` - Run specific auth tests
- `go test -bench=.` - Run benchmarks

### Testing
- Frontend tests: Access `http://localhost:8080/tests/auth_login_system_test.html`
- Backend tests: `go test -v ./tests/`
- Specific test pattern: `go test -v ./tests/ -run TestTemporaryUser`

## Architecture Overview

### Frontend (JavaScript)
- **Terminal Interface**: `js/retroterminal.js` - Main terminal logic and WebSocket communication
- **Graphics Engine**: `js/retrographics.js` - Retro CRT effects and vector graphics
- **Authentication**: `js/auth.js` - JWT token management and session handling
- **Audio Systems**: `js/retrosound.js`, `js/sidPlayer.js` - SAM speech synthesis and SID player
- **Rendering**: `js/renderLoop.js` - Optimized rendering loop with requestAnimationFrame

### Backend (Go)
Core packages in `pkg/`:
- **Terminal**: WebSocket management, client connections, and terminal modes (OS/BASIC/Chat)
- **TinyBASIC**: BASIC interpreter with graphics, sound, and AI integration commands
- **TinyOS**: Virtual operating system with filesystem and user management
- **Authentication**: JWT-based auth with special temporary user handling
- **Editor**: Built-in text editor with syntax highlighting and file management
- **Chess**: Chess engine with WebGL graphics
- **VirtualFS**: Virtual filesystem with SQLite persistence for users

### Key Design Patterns
- **Mode System**: Terminal operates in three modes: OS commands, BASIC interpreter, Chat
- **Resource Management**: Centralized managers for sessions, TinyBASIC instances, and prompts
- **Security Layers**: JWT authentication, input validation, and temporary user restrictions
- **WebSocket Protocol**: Custom JSON message format for terminal communication

## Configuration

### Settings Files
- `settings.cfg` - Main configuration (copy from `settings.cfg.template`)
- `settings.local.cfg` - Development overrides
- `settings.production.cfg` - Production settings

### Environment Variables
- `JWT_SECRET_KEY` - JWT signing key (auto-generated by setup scripts)
- `DEEPSEEK_API_KEY` - API key for AI chat integration
- `TLS_CERT_PATH`, `TLS_KEY_PATH` - SSL certificate paths

### Setup Scripts
- Windows: `setup-env.ps1` - Sets up environment variables and JWT secrets
- Linux/macOS: `setup-env.sh` - Cross-platform environment setup
- SSL Setup: `setup-letsencrypt.ps1` / `setup-letsencrypt.sh`

## Special Features

### Temporary User System
- User "dyson" is treated as temporary with special restrictions
- Tokens auto-expire on browser refresh, sessions cannot be restored
- Implemented in `pkg/auth/jwt.go:IsTemporaryUser()` and frontend `js/auth.js`

### AI Integration (MCP Commands)
- `mcp create <description>` - Generate BASIC programs using AI
- `mcp edit <description>` - Modify existing programs
- `mcp chat <message>` - Chat with AI assistant
- Prompts stored in `prompts/` directory

### Graphics and Media
- Vector graphics commands in TinyBASIC (VECTOR, SPRITE, etc.)
- SID music playback and SAM speech synthesis
- Chess game with WebGL rendering
- Retro CRT shader effects

## Development Workflow

### File Structure Notes
- `js/` files are bundled by `build.js` in specific order (see BUILD_SYSTEM.md)
- Backend uses modular package structure with clear separation of concerns
- Examples and content in `examples/`, `dyson/`, `chess_gfx/` directories
- Tests have comprehensive coverage for authentication system

### Common Tasks
1. **Adding JavaScript files**: Update `bundleJsFiles` array in `build.js`
2. **Backend changes**: Follow Go package structure in `pkg/`
3. **New TinyBASIC commands**: Add to appropriate command files in `pkg/tinybasic/`
4. **WebSocket protocol changes**: Update both frontend and `pkg/terminal/`

### Security Considerations
- All user input is validated and sanitized
- JWT tokens include temporary user flags and appropriate expiration
- WebSocket connections are authenticated
- Virtual filesystem restricts access patterns
- Special handling for temporary users prevents session persistence

## Debugging

### Log Files
- `debug.log` - Main application log
- Structured logging in `pkg/logger/` with different areas (TinyBasic, Auth, etc.)
- Frontend console logging for WebSocket and authentication events

### Development Tools
- `check-logging.ps1` - Log analysis script
- Debug builds preserve JavaScript formatting
- Test suite with detailed output and benchmarks

This codebase emphasizes retro computing aesthetics while maintaining modern security and development practices. The modular architecture allows for easy extension of commands, graphics capabilities, and system features.